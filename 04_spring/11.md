<h1>Projeto 02 - Blog Pessoal - Classe PostagemController - m√©todo Atualizar Postagem</h1>

O que veremos por aqui:

1. Criar o m√©todo put(Postagem postagem) para atualizar uma Postagem persistida no Banco de Dados

<h2>1. O Recurso Postagem</h2>

Nas etapas anteriores, come√ßamos a construir a Classe **PostagemController** e implementamos os m√©todos:

-  **getAll()**  ü°™ Retorna todos os objetos da Classe Postagem persistidos no Banco de dados.
-  **getById(Long id)** ü°™ Retorna um objeto espec√≠fico da Classe Postagem persistido no Banco de dados. A Postagem √© identificada pelo Atributo id.   
-  **getByTitulo(String titulo)** ü°™ Retorna  todos os objetos da Classe Postagem persistidos no Banco de dados, cujo Atributo titulo contenha a String enviada no par√¢metro titulo do m√©todo.   
-  **m√©todo post(Postagem postagem)** ü°™ Persiste (salva) um novo objeto da Classe Postagem no Banco de dados.

Vamos continuar a constru√ß√£o da nossa Classe Controladora implementando o **m√©todo put(Postagem postagem)**, que atualizar√° um objeto da Classe Postagem persistido no Banco de dados.

<div align="center"><img src="https://i.imgur.com/aKmFiA1.png" title="source: imgur.com" width="50%"/></div>

<br />

<h2>üë£ Passo 01 - Criar o m√©todo put(Postagem postagem)</h2>

Vamos implementar o m√©todo **put(Postagem postagem)** na Classe Postagem Controller. Observe que ele √© muito parecido com o m√©todo post. Tra√ßando um paralelo com o MySQL, seria o equivalente a instru√ß√£o: <code>UPDATE tb_postagens SET titulo = "titulo", texto = "texto", data = CURRENT_TIMESTAMP() WHERE id = id;</code>.

<div align="left"><img src="https://i.imgur.com/DDxkmrt.png" title="source: imgur.com" /></div>

**Linha 53:** a anota√ß√£o **@PutMapping** indica que o m√©todo put(Postagem postagem), responder√° a todas as requisi√ß√µes do tipo **HTTP PUT**, enviadas no endere√ßo **http://localhost:8080/postagens**.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *O Endere√ßo do Endpoint ser√° igual ao Endere√ßo do Recurso (@RequestMapping). Os m√©todos getAll() e post(Postagem postagem) utilizam o mesmo endere√ßo, por√©m como se tratam de verbos diferentes (O primeiro utiliza o verbo GET , o segundo utiliza o verbo POST e o terceiro utiliza o verbo PUT) o endere√ßo pode ser o mesmo.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

**Linha 54:** O m√©todo `put(@Valid @RequestBody Postagem postagem)` retorna um objeto do tipo `ResponseEntity` porque ele √© respons√°vel por **responder a uma requisi√ß√£o HTTP (HTTP Request)** com uma **resposta HTTP (HTTP Response)**.

Observe que o m√©todo possui um par√¢metro, que √© um objeto da classe `Postagem`, nomeado como **`postagem`**, e que ser√° recebido no corpo da requisi√ß√£o.

**@Valid:** Essa anota√ß√£o ativa a **valida√ß√£o autom√°tica** do objeto `postagem`, com base nas regras declaradas na model `Postagem`, como `@NotNull`, `@NotBlank`, `@Size`, entre outras.

Se algum campo violar essas regras, o Spring gerar√° automaticamente uma resposta com **status 400 (Bad Request)** contendo os detalhes do erro de valida√ß√£o.

**@RequestBody Postagem postagem:** Essa anota√ß√£o instrui o Spring a **converter automaticamente o JSON enviado no corpo da requisi√ß√£o** para um objeto da classe `Postagem`, que ser√° atribu√≠do ao par√¢metro `postagem`.

Essa convers√£o √© feita por meio de uma biblioteca chamada **Jackson** (que acompanha o Spring Boot por padr√£o).

> A **Jackson** √© uma biblioteca Java muito utilizada para **converter objetos Java em JSON** e **JSON em objetos Java**. Essa opera√ß√£o √© chamada de **serializa√ß√£o** (Java ‚Üí JSON) e **desserializa√ß√£o** (JSON ‚Üí Java).
>
> <br />
>
> <div align="left"><img src="https://i.imgur.com/14IR5P4.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/FasterXML/jackson-annotations" target="_blank"><b>Documenta√ß√£o: Biblioteca Jasckson</b></a></div>
>
> <br />

<img src="https://i.imgur.com/QKIS6Rm.png" title="source: imgur.com" height="20px"/>: No final do processo, o m√©todo retornar√° um objeto da **Classe ResponseEntity** contendo o  HTTP Status **OKü°™200** e no par√¢metro **body** (Corpo da Resposta), ser√° retornado o **objeto da Classe Postagem**, que foi atualizado no Banco de dados, na tabela **tb_postagens**.  

Observe que nesta linha tamb√©m foi utilizado o recurso **Java Generics** para definir o tipo do objeto que ser√° retornado no Corpo da Resposta `<T>`, onde **T** no caso √© o tipo Postagem.   

**Linha 55:**

**return postagemRepository.findById(postagem.getId()):** Executa o m√©todo `findById(id)` do reposit√≥rio. Esse m√©todo retorna um `Optional<Postagem>` contendo o objeto da classe `Postagem` persistido no banco de dados, caso ele seja encontrado com base no valor do atributo `id`. Esse `id` √© extra√≠do do objeto `postagem` recebido no corpo da requisi√ß√£o, no formato JSON, por meio do m√©todo `getId()`.

**.map(resposta ü°™ ResponseEntity.status(HttpStatus.OK).body(postagemRepository.save(postagem)):** Se o objeto da classe `Postagem` for encontrado, o m√©todo `map` do `Optional` ser√° executado. Dentro do `map`, ao inv√©s de retornar diretamente o objeto encontrado (`resposta`), utilizamos o `postagemRepository.save(postagem)` para **atualizar o registro no banco**, substituindo o conte√∫do anterior pelos novos dados recebidos no corpo da requisi√ß√£o.

Em seguida, o objeto atualizado √© retornado no corpo da resposta HTTP (`ResponseEntity`) com o status **200 OK**, indicando que a opera√ß√£o de atualiza√ß√£o foi conclu√≠da com sucesso.

O m√©todo save(postagem), em uma opera√ß√£o de atualiza√ß√£o, funciona da seguinte maneira:

- **Se o objeto enviado contiver um atributo `id`:** O Spring verifica se esse `id` existe no banco de dados. Se existir, os atributos do objeto ser√£o atualizados com os novos valores recebidos (exceto o `id`, que permanece o mesmo).
- **Se o objeto contiver um `id` inv√°lido ou inexistente:** O m√©todo `save()` tentar√° realizar a opera√ß√£o, mas, dependendo do contexto, poder√° lan√ßar uma exce√ß√£o (ver <a href="#anexo1">Anexo I</a>), pois o `id` n√£o corresponde a um registro existente. Para evitar esse erro, **verificamos previamente** se o objeto existe com o m√©todo `findById(Long id)` antes de chamar o m√©todo `save(postagem)`.
- **Se o objeto n√£o contiver o atributo `id`:** Sem a valida√ß√£o pr√©via do id, o m√©todo `save()` interpretar√° a requisi√ß√£o como uma **opera√ß√£o de cria√ß√£o**, e um novo registro ser√° inserido na tabela com um novo `id`. Isso pode gerar **duplicidade de dados** se a inten√ß√£o era apenas atualizar um registro existente.
- Ao implementar o **m√©todo HTTP `PUT`**, estamos realizando uma **atualiza√ß√£o total** do objeto. Isso significa que todos os atributos (exceto o `id`) ser√£o sobrescritos com os valores enviados no corpo da requisi√ß√£o. Por isso, √© importante que **todos os campos estejam preenchidos** corretamente no JSON enviado pelo cliente.
- Para permitir a atualiza√ß√£o de apenas alguns atributos (por exemplo, somente o `titulo` ou o `texto`), a abordagem adequada seria implementar o **m√©todo HTTP `PATCH`**. Nesse caso, apenas os campos informados no corpo da requisi√ß√£o ser√£o atualizados, mantendo os demais inalterados.

> O m√©todo **HTTP `PATCH`** √© utilizado para **atualizar parcialmente um recurso**. Ao contr√°rio do `PUT`, que exige que o **recurso completo** seja enviado na requisi√ß√£o, o `PATCH` permite que **somente os campos que devem ser modificados** sejam inclu√≠dos.

**.orElse(ResponseEntity.notFound().build());:** Se o objeto Postagem n√£o for encontrado (Optional vazio) pelo m√©todo findById(id), ser√° retornado o HTTP Status **NOT FOUND ü°™ 404** (N√£o Encontrado!). O m√©todo **build()** constr√≥i a Resposta com o HTTP Status retornado.

Depois de Criar o m√©todo, observe que foi importado mais 1 pacote, como mostra a imagem abaixo (indicado pela Seta vermelha):

<div align="left"><img src="https://i.imgur.com/sQahD3s.png" title="source: imgur.com" /></div>

Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**) e verificar se o Projeto est√° em execu√ß√£o.

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Methods" target="_blank"><b>Documenta√ß√£o: HTTP Request Methods</b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/PutMapping.html" target="_blank"><b>Documenta√ß√£o: <i>@PutMapping</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/ResponseEntity.html#created-java.net.URI-" target="_blank"><b>Documenta√ß√£o: <i>ResponseEntity</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpStatus.html#OK" target="_blank"><b>Documenta√ß√£o: <i>HttpStatus</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/CrudRepository.html?is-external=true#save-S-" target="_blank"><b>Documenta√ß√£o: <i>.save(T entidade)</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/RequestBody.html" target="_blank"><b>Documenta√ß√£o: <i>@RequestBody</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://jakarta.ee/specifications/bean-validation/3.0/apidocs/jakarta/validation/valid" target="_blank"><b>Documenta√ß√£o: <i>@Valid</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="3%"/> <a href="https://docs.oracle.com/javase/tutorial/java/generics/types.html" target="_blank"><b>Documenta√ß√£o: <i>Java Generics</i></b></a></div>

<br />

<h2>üë£ Passo 02 - Testar no Insomnia o m√©todo put</h2>

Agora vamos criar a Requisi√ß√£o para o **m√©todo put(Postagem postagem)**:

1. Clique com o bot√£o direito do mouse sobre a **Pasta Postagem** para abrir o menu e clique na op√ß√£o **New Request**.

<div align="center"><img src="https://i.imgur.com/KvRI8b2.png" title="source: imgur.com" /></div>

2.  Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Postagem**.

<div align="center"><img src="https://i.imgur.com/CA70WQn.png" title="source: imgur.com" /></div>

3. D√™ um duplo clique sobre a nova Requisi√ß√£o (**New Request**), informe o nome da Requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/ZQKmphk.png" title="source: imgur.com" /></div>

4. Selecione o m√©todo HTTP que ser√° utilizado (**PUT**) na Requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do objeto Postagem no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/c1hyPAK.png" title="source: imgur.com" /></div>

8. No item marcado em amarelo na imagem acima, informe o endere√ßo (endpoint) da Requisi√ß√£o. A requisi√ß√£o **Editar Postagem** foi configurada da seguinte maneira:

   - A primeira parte do endere√ßo (http://localhost:8080) √© o endere√ßo do nosso servidor local. Quando a API estiver na nuvem, ele ser√° substitu√≠do pelo endere√ßo da aplica√ß√£o na nuvem.
   - A segunda parte do endere√ßo √© o **endpoint** configurado na anota√ß√£o ***@RequestMapping***, em nosso caso  **/postagens**. 
   
9. Na guia **JSON**, precisamos inserir um **JSON** com os dados que ser√£o inseridos na nova postagem. Lembrando que no padr√£o JSON: **o texto antes dos 2 pontos** (:) √© o **Atributo** da Classe e **o texto depois dos 2 pontos** (:) √© o **dado** que ser√° cadastrado no Atributo.  Os atributos s√£o separados por virgula, como mostra a imagem acima.

   | <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** Observe que no m√©todo **PUT √© necess√°rio enviar o Atributo id** no JSON para identificar a Postagem que ser√° atualizada. A data n√£o precisa ser enviada, porqu√™ ela ser√° atualizada pela pr√≥pria aplica√ß√£o.</div> |
   | ------------------------------------------------------------ | ------------------------------------------------------------ |

10. Para testar a requisi√ß√£o, com a aplica√ß√£o rodando, clique no bot√£o <img src="https://i.imgur.com/sy0V8Nx.png" title="source: imgur.com" width="60px"/>.

11. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/vTn1BJ9.png" title="source: imgur.com" /></div>

12. Observe que a aplica√ß√£o retorna al√©m dos dados que foram atualizados no Banco de dados, ela tamb√©m retorna um **HTTP Status 200 ü°™ OK** (indicado em verde na imagem acima). Este Status indica que a Requisi√ß√£o foi bem sucedida!

13. Caso a Postagem n√£o seja encontrada, ser√° retornado o **HTTP Status 404 ü°™ NOT_FOUND**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/5lCAhBv.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_v3/tree/08_Classe_PostagemController_put" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<h2 id="anexo1">Anexo I - Principais Mensagens de Erro</h2>

| Erro                                                         | Descri√ß√£o                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ***Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect):*** | Esse erro geralmente ocorre em uma opera√ß√£o de **atualiza√ß√£o (`update`) ou exclus√£o (`delete`)**, quando o Hibernate **tenta atualizar ou deletar um registro que n√£o existe, j√° foi alterado ou removido por outra transa√ß√£o**, ou quando h√° **problemas no mapeamento do ID da entidade**. |


<br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

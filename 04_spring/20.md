<h1>Projeto 02 - Blog Pessoal - Spring Security - Ecossistema do Usu√°rio - Parte 02</h1>

O que veremos por aqui:

1. A Classe UsuarioService
2. A Classe UsuarioController
3. Testes no Insomnia

Vamos finalizar o Ecossistema do Usu√°rio.

<br />

<h2>üë£ Passo 01 - Criar o Pacote Service</h2>

1. Na Guia **Package explorer**, clique com o bot√£o direito do mouse sobre a Package **com.generation.blogpessoal**, na Source Folder **src/main/java** e clique na op√ß√£o  **New ü°™ Package**.

2. Na janela **New Java Package**, no item **Name**, acrescente no final do nome da Package **.service** e clique no bot√£o **Finish** para concluir.

<div align="center"><img src="https://i.imgur.com/xTtAHJu.png" title="source: imgur.com" width="65%"/></div>

<br />

<h2>üë£ Passo 02 - Criar a Classe UsuarioService na Camada Service</h2>

A **Classe UsuarioService** √© respons√°vel por manipular as regras de neg√≥cio de usu√°rio no sistema. Esta Classe deve ser anotada com a anota√ß√£o **@Service**, para que o Spring identifique que √© uma Classe que servi√ßo. Vale mencionar que alguns M√©todos definidos abaixo s√£o de extrema import√¢ncia para a Spring Security. 

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *O uso da Classe de Servi√ßo n√£o se restringe apenas a Spring Security, ela pode ser utilizada em qualquer endpoint para criar Regras de Neg√≥cio. Exemplo: N√£o permitir postagens ou temas duplicados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.service**), na Source Folder Principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioService**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

A Implementa√ß√£o completa da **Classe UsuarioService**, voc√™ confere abaixo:

```java
package com.generation.blogpessoal.service;

import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.repository.UsuarioRepository;
import com.generation.blogpessoal.security.JwtService;

@Service
public class UsuarioService {

	@Autowired
	private UsuarioRepository usuarioRepository;

	@Autowired
    private JwtService jwtService;

    @Autowired
    private AuthenticationManager authenticationManager;

	public Optional<Usuario> cadastrarUsuario(Usuario usuario) {

		if (usuarioRepository.findByUsuario(usuario.getUsuario()).isPresent())
			return Optional.empty();

		usuario.setSenha(criptografarSenha(usuario.getSenha()));

		return Optional.of(usuarioRepository.save(usuario));
	
	}

	public Optional<Usuario> atualizarUsuario(Usuario usuario) {
		
		if(usuarioRepository.findById(usuario.getId()).isPresent()) {

			Optional<Usuario> buscaUsuario = usuarioRepository.findByUsuario(usuario.getUsuario());

			if ( (buscaUsuario.isPresent()) && ( buscaUsuario.get().getId() != usuario.getId()))
				throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Usu√°rio j√° existe!", null);

			usuario.setSenha(criptografarSenha(usuario.getSenha()));

			return Optional.ofNullable(usuarioRepository.save(usuario));
			
		}

		return Optional.empty();
	
	}	

	public Optional<UsuarioLogin> autenticarUsuario(Optional<UsuarioLogin> usuarioLogin) {
        
        // Gera o Objeto de autentica√ß√£o
		var credenciais = new UsernamePasswordAuthenticationToken(usuarioLogin.get().getUsuario(), usuarioLogin.get().getSenha());
		
        // Autentica o Usuario
		Authentication authentication = authenticationManager.authenticate(credenciais);
        
        // Se a autentica√ß√£o foi efetuada com sucesso
		if (authentication.isAuthenticated()) {

            // Busca os dados do usu√°rio
			Optional<Usuario> usuario = usuarioRepository.findByUsuario(usuarioLogin.get().getUsuario());

            // Se o usu√°rio foi encontrado
			if (usuario.isPresent()) {

                // Preenche o Objeto usuarioLogin com os dados encontrados 
			   usuarioLogin.get().setId(usuario.get().getId());
                usuarioLogin.get().setNome(usuario.get().getNome());
                usuarioLogin.get().setFoto(usuario.get().getFoto());
                usuarioLogin.get().setToken(gerarToken(usuarioLogin.get().getUsuario()));
                usuarioLogin.get().setSenha("");
				
                 // Retorna o Objeto preenchido
			   return usuarioLogin;
			
			}

        } 
            
		return Optional.empty();

    }

	private String criptografarSenha(String senha) {

		BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
		
		return encoder.encode(senha);

	}

	private String gerarToken(String usuario) {
		return "Bearer " + jwtService.generateToken(usuario);
	}

}
```

Observe que foram criados os M√©todos **cadastrarUsuario()** e **atualizarUsuario()**, que criptografam a senha e impedem a duplica√ß√£o do usu√°rio no Banco de dados. O M√©todo **autenticarUsuario()**, al√©m de autenticar o usu√°rio no sistema, ele tamb√©m gera o **Token JWT** do usu√°rio.

Foram criados ainda 2 M√©todos auxiliares: **criptografarSenha() e gerarToken()**, para realizar fun√ß√µes espec√≠ficas na Classe de Servi√ßo. 

Observe que no M√©todo **autenticarUsuario**, para efetuar a autentica√ß√£o do usu√°rio foram criados Objetos das Classes **UsernamePasswordAuthenticationToken**, que cria o Objeto de autentica√ß√£o (credenciais) contendo os dados do usu√°rio (e-mail e senha) e **Authentication**, que autenticar√° o usu√°rio com o Objeto de autentica√ß√£o (credenciais), atrav√©s do M√©todo **authenticationManager.authenticate()**. Para checar se o usu√°rio foi autenticado corretamente, foi utilizado o M√©todo **authentication.isAuthenticated()**, da Classe **Authentication**.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, o cadastro de um novo usu√°rio no sistema necessita ser validado no Banco de dados. Caso o usu√°rio j√° exista, a aplica√ß√£o n√£o deve permitir que ele seja criado novamente, pois um usu√°rio duplicado no sistema ocasionar√° um erro HTTP Status 500.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="200px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, ao atualizar um usu√°rio √© importante que seja validado novamente a criptografia da senha e o usu√°rio (e-mail). Caso n√£o seja validado ocasionar√° um problema ao tentar autenticar pelo front-end da aplica√ß√£o.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, ao utilizar o M√©todo autenticarUsuario, certifique que todos os Atributos do Objeto usuarioLogin, exceto a senha, sejam preenchidos com os dados recuperados do Banco de dados, pois o mesmo ser√° utilizado pelo front-end da aplica√ß√£o.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, ao construir o M√©todo gerarToken. Observe que ap√≥s a palavra Bearer √© obrigat√≥rio adicionar um espa√ßo em branco, caso contr√°rio o Token JWT n√£o ser√° validado pela Classe JwtService.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/stereotype/Service.html" target="_blank"><b>Documenta√ß√£o: <i>@Service</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/9B46Slv.png" title="source: imgur.com" width="3%"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html" target="_blank"><b>Documenta√ß√£o: <i>BCryptPasswordEncoder - Java Doc Spring</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="30px"/> <a href="https://docs.google.com/document/d/1IQwgepFjSVCsMWiLHCidJyAj3jF2xp5h/edit" target="_blank"><b>Documenta√ß√£o: <i>Optional</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="30px"/> <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/throwing.html" target="_blank"><b>Documenta√ß√£o: Throw</b></a></div>

<br />


<h2>üë£ Passo 03 - Criar a Classe UsuarioController na Camada Controller</h2>

A Classe **UsuarioController**, √© respons√°vel por fornecer o acesso aos recursos do sistema. Uma das suas funcionalidades abaixo √© promover o CRUD do usu√°rio. Al√©m de permitir total manipula√ß√£o do usu√°rio, consumindo os servi√ßos cadastrar usu√°rio, atualizar usu√°rio e autenticar da Classe UsuarioService.

1. Clique com o bot√£o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.controller**), na Source Folder Principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioController**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

A seguir veja sua implementa√ß√£o:

```java
package com.generation.blogpessoal.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.repository.UsuarioRepository;
import com.generation.blogpessoal.service.UsuarioService;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/usuarios")
@CrossOrigin(origins = "*", allowedHeaders = "*")
public class UsuarioController {

	@Autowired
	private UsuarioService usuarioService;

	@Autowired
	private UsuarioRepository usuarioRepository;
	
	@GetMapping("/all")
	public ResponseEntity <List<Usuario>> getAll(){
		
		return ResponseEntity.ok(usuarioRepository.findAll());
		
	}

	@GetMapping("/{id}")
	public ResponseEntity<Usuario> getById(@PathVariable Long id) {
		return usuarioRepository.findById(id)
			.map(resposta -> ResponseEntity.ok(resposta))
			.orElse(ResponseEntity.notFound().build());
	}
	
	@PostMapping("/logar")
	public ResponseEntity<UsuarioLogin> autenticarUsuario(@RequestBody Optional<UsuarioLogin> usuarioLogin){
		
		return usuarioService.autenticarUsuario(usuarioLogin)
				.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
				.orElse(ResponseEntity.status(HttpStatus.UNAUTHORIZED).build());
	}
    

	@PostMapping("/cadastrar")
	public ResponseEntity<Usuario> postUsuario(@RequestBody @Valid Usuario usuario) {

		return usuarioService.cadastrarUsuario(usuario)
			.map(resposta -> ResponseEntity.status(HttpStatus.CREATED).body(resposta))
			.orElse(ResponseEntity.status(HttpStatus.BAD_REQUEST).build());

	}

	@PutMapping("/atualizar")
	public ResponseEntity<Usuario> putUsuario(@Valid @RequestBody Usuario usuario) {
		
		return usuarioService.atualizarUsuario(usuario)
			.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
			.orElse(ResponseEntity.status(HttpStatus.NOT_FOUND).build());
		
	}

}
```

Observe que nos M√©todos Cadastrar, Atualizar e Autenticar, ao inv√©s de usarmos a inje√ß√£o de depend√™ncia da Interface UsuarioRepository, estamos utilizando a inje√ß√£o de depend√™ncia da Classe de Servi√ßo **UsuarioService** porqu√™ os 3 M√©todos foram implementados nela.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left">ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, nos M√©todos postUsuario e putUsuario para n√£o esquecer a nota√ß√£o @Valid. Caso ela n√£o seja inserida, ao fornecer par√¢metros inv√°lidos, o servidor retornar√° o HTTP Status 500, ao inv√©s do HTTP Status 400.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />


<h2>üë£ Passo 04 - Testar o Recurso Usuario no Insomnia</h2>

Vamos criar no Insomnia todas as requisi√ß√µes necess√°rias para testar os 5 M√©todos do Recurso Usuario. Veja abaixo como ficam as requisi√ß√µes para testar o Recurso Usuario:

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Requisi√ß√µes, consulte a Documenta√ß√£o dos Recursos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <div align="left"> **ATEN√á√ÉO:** *Depois de criar o Relacionamento entre Classes, todas as Consultas dos Recursos Postagem, Tema e Usuario trar√£o os Objetos associados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>4.1. Criando a Pasta Usuario</h3>

Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardar√° todas as requisi√ß√µes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no bot√£o <img src="https://i.imgur.com/3Ou2SAZ.png" title="source: imgur.com" width="6%"/>. No menu que ser√° aberto, clique na op√ß√£o **New Folder**.

<div align="center"><img src="https://i.imgur.com/gIGZFHc.png" title="source: imgur.com" width="50%"/></div>

2. Na janela que ser√° aberta, informe o nome da pasta (**Usuario**) e clique no bot√£o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/etf4wwv.png" title="source: imgur.com" width="90%"/></div>

<br />

<h3>4.2. Criando a  Requisi√ß√£o - Cadastrar Usuario</h3>

Vamos come√ßar pela requisi√ß√£o Cadastrar Usuario porqu√™ sem um usu√°rio cadastrado n√£o ser√° poss√≠vel autenticar (logar) no sistema e acessar os demais endpoints.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

<div align="center"><img src="https://i.imgur.com/gEzaJVM.png" title="source: imgur.com" /></div>

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.
3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/2199dTU.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo Post o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o nome, o usuario(e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplica√ß√£o retornar√° a senha criptografada.

<div align="center"><img src="https://i.imgur.com/GPIA7LX.png" title="source: imgur.com" /></div>

<br />

<h3>4.3. Criando a Requisi√ß√£o - Autenticar Usuario (Login)</h3>

Usu√°rio persistido, agora vamos efetuar o login no sistema, que nos retornar√° o **Token de Autoriza√ß√£o**, que nos permitir√° consumir os demais endpoints e recursos da aplica√ß√£o.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/sVVW1sF.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/f2NvyEo.png" title="source: imgur.com" /></div>

8. Observe que no JSON estamos passando apenas o usu√°rio e a senha, porqu√™ s√£o as √∫nicas informa√ß√µes que utilizaremos no login. A Classe UsuarioLogin possui outros Atributos que ser√£o preenchidos (exceto a senha) pela aplica√ß√£o (se o login for efetuado com sucesso) e retornados no JSON da resposta, como vemos na figura abaixo:

<div align="center"><img src="https://i.imgur.com/H5gkNzF.png" title="source: imgur.com" /></div>

9. Observe que o Token foi gerado e enviado na resposta. Copie o Token da resposta porqu√™ vamos precisar dele nas pr√≥ximas requisi√ß√µes.

<div align="center"><img src="https://i.imgur.com/GhBcfMt.png" title="source: imgur.com" /></div>

10. Caso o login falhe, voc√™ receber√° o **status 403 (Forbidden)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/PxmSjdZ.png" title="source: imgur.com" /></div>

11. Observe que na propriedade **trace** (indicada pela seta), foi lan√ßada a Exce√ß√£o **Bad Credentials**, ou seja, usuario e/ou senha incorretos.

<br />

<h3>4.4. Criando a  Requisi√ß√£o - Consultar todos os Usuarios - findAll()</h3>

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/sHaqXfI.png" title="source: imgur.com" /></div>

6. Como a seguran√ßa foi habilitada, caso voc√™ envie a requisi√ß√£o do jeito que est√°, voc√™ receber√° o **HTTP status 401 (Unauthorized)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/tP6IoZJ.png" title="source: imgur.com" /></div>

7. A explica√ß√£o √© simples: **Voc√™ precisa passar no cabe√ßalho da requisi√ß√£o o Token JWT recebido no login**, caso contr√°rio n√£o ser√° poss√≠vel efetuar nenhuma opera√ß√£o dentro da API. 

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <div align="left"> **ATEN√á√ÉO:** *No Frontend, independente de ser implementado no Angular ou no React, a passagem do Token ser√° automatizada.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

8. Clique na Guia **Headers** e adicione uma nova linha de cabe√ßalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

9. Na coluna **New header** digite **Authorization**. Na coluna **New value** da linha insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/d4MGeap.png" title="source: imgur.com" /></div>

10. Agora a sua requisi√ß√£o funcionar√°!

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left">ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes! Voc√™ dever√° inserir o Token JWT no cabe√ßalho de todas as Requisi√ß√µes dos Recursos Postagem, Tema e Usuario (Exceto Cadastrar e Autenticar), caso contr√°rio voc√™ receber√° o status 401 (Unauthorized) em todas elas.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>4.5. Criando a  Requisi√ß√£o - Consultar Usuario por ID - findById(id)</h3>

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/RLUrAOZ.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/tQgQcsz.png" title="source: imgur.com" /></div>

6. Clique na Guia **Header** e adicione uma nova linha de cabe√ßalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

7. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/Izd1nAW.png" title="source: imgur.com" /></div>

<br />

<h3>4.6. Criando a  Requisi√ß√£o - Atualizar Usu√°rio</h3>

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Requisi√ß√£o**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endere√ßo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/H5RRlRg.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo **PUT** o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

9. Clique na Guia **Header** e adicione uma nova linha de cabe√ßalho.


<div align="center"><img src="https://i.imgur.com/bRBvX71.png" title="source: imgur.com" /></div>

10. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 05 - Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem  no Insomnia</h2>

Como habilitamos o Relacionamento entre as Classes Postagem e Usuario, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- O Tema e o Usuario devem ser persistidos antes de criar a nova Postagem.
- Na requisi√ß√£o Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisi√ß√£o deve conter um Objeto da Classe Tema identificado apenas pelo **Atributo id** e um Objeto da Classe Usuario identificado apenas pelo **Atributo id**.

<br />

<h3>5.1. Atualiza√ß√£o - Requisi√ß√£o Cadastrar Postagem</h3>

Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/D46gazO.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Cadastrar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>5.2. Atualiza√ß√£o - Requisi√ß√£o Atualizar Postagem</h3>

Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/ovpUW1C.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Atualizar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="center"><h2>IMPORTANTE!</h2></div>

Caso em alguma Requisi√ß√£o com o Token JWT inserido no cabe√ßalho, retorne o **HTTP status 403 (Forbidden)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/RagAaMk.png" title="source: imgur.com" /></div>

**Significa que o Token JWT Expirou!** 

Lembre-se que o **Token JWT foi configurado com um limite de 1 hora** e depois deste per√≠odo ele deixa de funcionar. Refa√ßa o login e atualize o Token de todas as Requisi√ß√µes HTTP.

<br/>

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_v3/tree/14_Classe_UsuarioService" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>


<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

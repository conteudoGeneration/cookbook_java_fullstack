<h1>Projeto 02 - Blog Pessoal - Spring Security - Ecossistema do Usu√°rio - Parte 02</h1>



### O que veremos por aqui:

1. A classe **UsuarioService**
2. A classe **UsuarioController**
3. Testes utilizando o **Insomnia**

Com isso, vamos concluir a constru√ß√£o do ecossistema relacionado ao usu√°rio na aplica√ß√£o.

<br />

<h2>üë£ Passo 01 - Criar o Pacote Service</h2>



1. Na Guia **Package explorer**, clique com o bot√£o direito do mouse sobre a **package com.generation.blogpessoal**, na Source Folder **src/main/java** e clique na op√ß√£o  **New ü°™ Package**.

2. Na janela **New Java Package**, no item **Name**, acrescente no final do nome da Package **.service** e clique no bot√£o **Finish** para concluir.

<div align="center"><img src="https://i.imgur.com/xTtAHJu.png" title="source: imgur.com" width="65%"/></div>

<br />

<h2>üë£ Passo 02 - Criar a Classe UsuarioService na Camada Service</h2>



A **classe UsuarioService** √© respons√°vel por gerenciar as regras de neg√≥cio relacionadas aos usu√°rios no sistema. Ela deve ser anotada com **@Service**, para que o Spring reconhe√ßa essa classe como um componente de servi√ßo gerenciado pelo framework. √â importante destacar que alguns m√©todos implementados nessa classe possuem papel fundamental para o funcionamento da Spring Security.

>**Regras de neg√≥cio** s√£o as diretrizes e condi√ß√µes que definem como uma aplica√ß√£o deve funcionar para atender aos objetivos espec√≠ficos de um neg√≥cio ou sistema. Elas determinam o que pode ou n√£o ser feito dentro do sistema, garantindo que as opera√ß√µes sigam as normas, pol√≠ticas e processos da empresa ou contexto em quest√£o. Essas regras s√£o fundamentais para que a aplica√ß√£o execute tarefas de forma correta e consistente.
>
>No desenvolvimento de software, as regras de neg√≥cio normalmente ficam centralizadas na camada de servi√ßo (Service), onde s√£o implementadas as valida√ß√µes, c√°lculos, decis√µes e fluxos que regem o comportamento da aplica√ß√£o. 
>
>Por exemplo, uma regra pode definir que um usu√°rio n√£o pode se cadastrar com um nome j√° existente, ou que uma transa√ß√£o financeira s√≥ √© autorizada se houver saldo suficiente na conta.
>
>Assim, as regras de neg√≥cio s√£o essenciais para manter a integridade dos dados e assegurar que o sistema cumpra seu prop√≥sito, al√©m de facilitar a manuten√ß√£o e evolu√ß√£o da aplica√ß√£o, pois elas est√£o separadas da l√≥gica t√©cnica e da interface do usu√°rio.

<br />

> [!WARNING]
>
> A anota√ß√£o `@Service` n√£o √© exclusiva da Spring Security. Ela pode ser aplicada a qualquer classe da aplica√ß√£o que represente um servi√ßo e que precise ser gerenciada pelo Spring, permitindo a inje√ß√£o de depend√™ncias e o gerenciamento do ciclo de vida do componente.

<br />

1. Clique com o bot√£o direito do mouse sobre o **pacote com.generation.blogpessoal.service), na source folder principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioService**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

Vejamos abaixo a implementa√ß√£o da Classe **UsuarioService**:

<div align="center"><img src="https://i.imgur.com/K03NJSE.png" title="source: imgur.com" /></div>

**Linha 1 a 17:** O c√≥digo inicia definindo o pacote da classe e importando todas as depend√™ncias necess√°rias, como classes do Spring (servi√ßos, autentica√ß√£o, criptografia), modelos do sistema (Usuario, UsuarioLogin), reposit√≥rios e a classe de servi√ßo JWT. Isso prepara o ambiente para a implementa√ß√£o dos m√©todos que manipular√£o dados de usu√°rios e seguran√ßa.

<div align="center"><img src="https://i.imgur.com/DNtoR8U.png" title="source: imgur.com" /></div>

**Linha 19:** A classe √© anotada com `@Service`, indicando que √© um componente de servi√ßo gerenciado pelo Spring. Isso permite que outras classes possam injetar esta classe automaticamente para usar seus m√©todos.

**Linhas 22 a 32:** S√£o declaradas as depend√™ncias que ser√£o injetadas automaticamente pelo Spring por meio da anota√ß√£o `@Autowired`. S√£o elas: 

- O reposit√≥rio de usu√°rios (`usuarioRepository`) para acesso ao banco de dados.
- O servi√ßo de JWT (`jwtService`) para gera√ß√£o de tokens.
- O gerenciador de autentica√ß√£o (`authenticationManager`) para validar credenciais.
- O codificador de senha (`passwordEncoder`) para criptografia das senhas.

<div align="center"><img src="https://i.imgur.com/RM00gyJ.png" title="source: imgur.com" /></div>

**Linha 34 a 36:** O m√©todo `getAll()` retorna a lista completa de usu√°rios cadastrados, buscando todos os registros no banco via o reposit√≥rio.

<div align="center"><img src="https://i.imgur.com/zUeGAQv.png" title="source: imgur.com" /></div>

**Linha 38 a 40:** O m√©todo `getById(Long id)` retorna um usu√°rio espec√≠fico a partir do seu ID, usando o m√©todo `findById` do reposit√≥rio, que retorna um `Optional<Usuario>`, permitindo tratar a aus√™ncia do usu√°rio.

<div align="center"><img src="https://i.imgur.com/dEBZPTZ.png" title="source: imgur.com" /></div>

**Linha 42 a 52:** O m√©todo `cadastrarUsuario(Usuario usuario)` √© respons√°vel por criar um novo usu√°rio. 

Primeiro, verifica se j√° existe um usu√°rio com o mesmo nome (`usuario.getUsuario()`). 

Se existir, retorna um `Optional.empty()` indicando falha no cadastro. Caso contr√°rio, criptografa a senha, zera o ID para garantir que seja um novo registro e salva o usu√°rio no banco, retornando o usu√°rio criado.

<div align="center"><img src="https://i.imgur.com/SWFfHS1.png" title="source: imgur.com" /></div>

**Linha 54 a 68:** O m√©todo `atualizarUsuario(Usuario usuario)` atualiza um usu√°rio existente. 

Primeiro, verifica se o usu√°rio com o ID informado existe; se n√£o, retorna vazio. Depois, verifica se o e-mail do usu√°rio (atributo usuario), j√° est√° sendo usado por outro usu√°rio diferente, e caso positivo lan√ßa uma exce√ß√£o com status HTTP 400 (Bad Request). 

Se passar nessas valida√ß√µes, criptografa a senha e atualiza o usu√°rio salvando as mudan√ßas no banco.

<div align="center"><img src="https://i.imgur.com/un3dyY4.png" title="source: imgur.com" /></div>

**Linha 70:** O m√©todo `autenticarUsuario` √© declarado como p√∫blico e recebe um par√¢metro do tipo `Optional<UsuarioLogin>`, que representa os dados de login enviados pelo usu√°rio (nome de usu√°rio e senha). 

Ele retorna um `Optional<UsuarioLogin>`, que conter√° as informa√ß√µes do usu√°rio autenticado com o token gerado, ou estar√° vazio em caso de falha.

**Linhas 72 a 74:** Verifica se o objeto `usuarioLogin` est√° vazio (n√£o cont√©m dados). Se estiver vazio, o m√©todo retorna imediatamente um `Optional.empty()`, indicando que n√£o h√° dados para autenticar.

**Linha 76:** Extrai o objeto `UsuarioLogin` de dentro do `Optional`, assumindo que ele est√° presente a partir deste ponto.

**Linhas 78 a 89:** Inicia um bloco `try` para tentar autenticar as credenciais do usu√°rio. Isso serve para capturar poss√≠veis erros durante o processo de autentica√ß√£o.

**Linhas 80 e 81:** Utiliza o `authenticationManager` para realizar a autentica√ß√£o. Para isso, cria um objeto `UsernamePasswordAuthenticationToken` com o nome de usu√°rio e senha extra√≠dos do objeto `login`. Esse token √© usado pelo Spring Security para verificar se as credenciais s√£o v√°lidas.

**Linha 83:** Se a autentica√ß√£o for bem-sucedida, o m√©todo busca no banco de dados o usu√°rio pelo nome de usu√°rio usando o reposit√≥rio `usuarioRepository`. O resultado √© um `Optional<Usuario>`.

**Linha 84:** Caso o usu√°rio seja encontrado, o m√©todo usa o m√©todo `map` do Optional para transformar o objeto `Usuario` encontrado na resposta que ser√° enviada ao cliente. 

Ele chama o m√©todo `construirRespostaLogin`, passando os dados de login e o usu√°rio para preparar o objeto final com os dados atualizados e o token JWT.

**Linha 86:** Caso ocorra qualquer exce√ß√£o durante a autentica√ß√£o (como credenciais inv√°lidas ou erro no banco), o fluxo pula para o bloco `catch`.

**Linha 87:** Dentro do bloco `catch`, o m√©todo retorna um `Optional.empty()`, indicando que a autentica√ß√£o falhou e n√£o ser√° retornado nenhum dado ao cliente.

<div align="center"><img src="https://i.imgur.com/2ha7rdv.png" title="source: imgur.com" /></div>

**Linha 92 a 101:** O m√©todo privado `construirRespostaLogin(UsuarioLogin usuarioLogin, Usuario usuario)` monta a resposta de login para o front-end. 

Ele atualiza o objeto `usuarioLogin` com dados do usu√°rio (ID, nome, foto), limpa a senha por seguran√ßa, gera o token JWT e o insere no objeto. 

Em seguida, retorna esse objeto pronto para ser enviado.

<div align="center"><img src="https://i.imgur.com/1KIVW2l.png" title="source: imgur.com" /></div>

**Linha 95 a 98:** O m√©todo privado `gerarToken(String usuario)` cria o token JWT usando o servi√ßo `jwtService` e adiciona o prefixo `"Bearer "` que √© o padr√£o para tokens no cabe√ßalho Authorization.

> [!WARNING]
>
> **O espa√ßo em branco entre a palavra Bearer e o Token JWT √© obrigat√≥rio.** 

<br />

üíæ **Salve as altera√ß√µes antes de prosseguir ( File ü°™ Save All )!**

A Implementa√ß√£o completa da **Classe UsuarioService**, voc√™ confere abaixo:

```java
package com.generation.blogpessoal.service;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.repository.UsuarioRepository;
import com.generation.blogpessoal.security.JwtService;

@Service
public class UsuarioService {

	@Autowired
	private UsuarioRepository usuarioRepository;

	@Autowired
	private JwtService jwtService;

	@Autowired
	private AuthenticationManager authenticationManager;

	@Autowired
	private PasswordEncoder passwordEncoder;

	public List<Usuario> getAll() {
		return usuarioRepository.findAll();
	}

	public Optional<Usuario> getById(Long id) {
		return usuarioRepository.findById(id);
	}

	public Optional<Usuario> cadastrarUsuario(Usuario usuario) {

		if (usuarioRepository.findByUsuario(usuario.getUsuario()).isPresent()) {
			return Optional.empty();
		}

		usuario.setSenha(passwordEncoder.encode(usuario.getSenha()));
		usuario.setId(null);
		
		return Optional.of(usuarioRepository.save(usuario));
	}

	public Optional<Usuario> atualizarUsuario(Usuario usuario) {

		if (!usuarioRepository.findById(usuario.getId()).isPresent()) {
			return Optional.empty();
		}

		Optional<Usuario> usuarioExistente = usuarioRepository.findByUsuario(usuario.getUsuario());
		
		if (usuarioExistente.isPresent() && !usuarioExistente.get().getId().equals(usuario.getId())) {
			throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Usu√°rio j√° existe!", null);
		}

		usuario.setSenha(passwordEncoder.encode(usuario.getSenha()));
		return Optional.of(usuarioRepository.save(usuario));
	}
	
	public Optional<UsuarioLogin> autenticarUsuario(Optional<UsuarioLogin> usuarioLogin) {

		if (!usuarioLogin.isPresent()) {
			return Optional.empty();
		}

		UsuarioLogin login = usuarioLogin.get();
		
		try {
 
			authenticationManager.authenticate(
					new UsernamePasswordAuthenticationToken(login.getUsuario(), login.getSenha()));

			return usuarioRepository.findByUsuario(login.getUsuario())
				.map(usuario -> construirRespostaLogin(login, usuario));

		} catch (Exception e) {

			return Optional.empty();
		}
	}

	private UsuarioLogin construirRespostaLogin(UsuarioLogin usuarioLogin, Usuario usuario) {
		
		usuarioLogin.setId(usuario.getId());
		usuarioLogin.setNome(usuario.getNome());
		usuarioLogin.setFoto(usuario.getFoto());
		usuarioLogin.setSenha("");
		usuarioLogin.setToken(gerarToken(usuario.getUsuario()));
		return usuarioLogin;
		
	}

	private String gerarToken(String usuario) {
		return "Bearer " + jwtService.generateToken(usuario);
	}
}
```

<br />

üíæ **Salve as altera√ß√µes antes de prosseguir ( File ü°™ Save All )!**

<br />

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="4%"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/stereotype/Service.html" target="_blank"><b>Documenta√ß√£o: <i>@Service</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/9B46Slv.png" title="source: imgur.com" width="4%"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html" target="_blank"><b>Documenta√ß√£o: <i>BCryptPasswordEncoder - Java Doc Spring</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="4%"/> <a href="https://docs.google.com/document/d/1IQwgepFjSVCsMWiLHCidJyAj3jF2xp5h/edit" target="_blank"><b>Documenta√ß√£o: <i>Optional</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="4%"/> <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/throwing.html" target="_blank"><b>Documenta√ß√£o: Throw</b></a></div>

<br />


<h2>üë£ Passo 03 - Criar a Classe UsuarioController na Camada Controller</h2>



A classe **UsuarioController** √© respons√°vel por expor os recursos do sistema relacionados ao usu√°rio, disponibilizando as opera√ß√µes necess√°rias para o consumo externo, geralmente por meio de APIs REST. Entre suas funcionalidades, est√° a implementa√ß√£o completa do CRUD (Criar, Ler, Atualizar e Deletar) do usu√°rio.

Al√©m de permitir a manipula√ß√£o dos dados dos usu√°rios, o controlador atua como intermedi√°rio, consumindo os servi√ßos da classe **UsuarioService**, como cadastrar usu√°rio, atualizar usu√°rio e autenticar, garantindo a separa√ß√£o entre a l√≥gica de neg√≥cio e a interface de acesso.

1. Clique com o bot√£o direito do mouse sobre o **pacote com.generation.blogpessoal.controller**, na source folder principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioController**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

A seguir veja sua implementa√ß√£o:

```java
package com.generation.blogpessoal.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.service.UsuarioService;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/usuarios")
@CrossOrigin(origins = "*", allowedHeaders = "*")
public class UsuarioController {

	@Autowired
	private UsuarioService usuarioService;
	
	@GetMapping("/all")
	public ResponseEntity<List<Usuario>> getAll() {

		return ResponseEntity.ok(usuarioService.getAll());

	}

	@GetMapping("/{id}")
	public ResponseEntity<Usuario> getById(@PathVariable Long id) {
		return usuarioService.getById(id)
				.map(resposta -> ResponseEntity.ok(resposta))
				.orElse(ResponseEntity.status(HttpStatus.NOT_FOUND).build());
	}

	@PostMapping("/cadastrar")
	public ResponseEntity<Usuario> post(@Valid @RequestBody Usuario usuario) {
		return usuarioService.cadastrarUsuario(usuario)
				.map(resposta -> ResponseEntity.status(HttpStatus.CREATED).body(resposta))
				.orElse(ResponseEntity.status(HttpStatus.BAD_REQUEST).build());
	}

	@PutMapping("/atualizar")
	public ResponseEntity<Usuario> put(@Valid @RequestBody Usuario usuario) {
		return usuarioService.atualizarUsuario(usuario)
				.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
				.orElse(ResponseEntity.status(HttpStatus.NOT_FOUND).build());
	}

	@PostMapping("/logar")
	public ResponseEntity<UsuarioLogin> autenticar(@Valid @RequestBody Optional<UsuarioLogin> usuarioLogin) {
		return usuarioService.autenticarUsuario(usuarioLogin)
				.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
				.orElse(ResponseEntity.status(HttpStatus.UNAUTHORIZED).build());
	}
	
}
```

Observe que, ao inv√©s de injetarmos diretamente a interface **UsuarioRepository**, estamos utilizando a inje√ß√£o de depend√™ncia da classe de servi√ßo **UsuarioService**. Isso ocorre porque todos os m√©todos relacionados √† manipula√ß√£o dos dados do usu√°rio foram implementados na camada de servi√ßo, garantindo uma melhor organiza√ß√£o e separa√ß√£o das responsabilidades no c√≥digo.

<br />

üíæ **Salve as altera√ß√µes antes de prosseguir ( File ü°™ Save All )!**

<br />


<h2>üë£ Passo 04 - Testar o Recurso Usuario no Insomnia</h2>



Vamos criar no Insomnia todas as requisi√ß√µes necess√°rias para testar os 5 M√©todos do Recurso Usuario. Veja abaixo como ficam as requisi√ß√µes para testar o Recurso Usuario:

<br />

> [!TIP]
>
> üëâ Caso voc√™ tenha alguma d√∫vida sobre como criar as requisi√ß√µes no Insomnia, entre outras, **consulte os conte√∫dos referentes a constru√ß√£o dos Recursos Postagem e Tema**.

<br />

> [!IMPORTANT]
>
> Ap√≥s estabelecer o relacionamento entre as classes, todas as consultas dos recursos **Postagem**, **Tema** e **Usuario** passar√£o a incluir automaticamente os objetos associados. Isso significa que, ao buscar uma postagem, por exemplo, ser√° poss√≠vel obter tamb√©m as informa√ß√µes relacionadas ao tema e ao usu√°rio vinculados, facilitando o acesso a dados relacionados e otimizando as opera√ß√µes da aplica√ß√£o.

<br />

<h3>4.1. Criando a Pasta Usuario</h3>



Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardar√° todas as requisi√ß√µes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no bot√£o <img src="https://i.imgur.com/3Ou2SAZ.png" title="source: imgur.com" width="6%"/>. No menu que ser√° aberto, clique na op√ß√£o **New Folder**.

<div align="center"><img src="https://i.imgur.com/gIGZFHc.png" title="source: imgur.com" width="50%"/></div>

2. Na janela que ser√° aberta, informe o nome da pasta (**Usuario**) e clique no bot√£o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/etf4wwv.png" title="source: imgur.com" width="90%"/></div>

<br />

<h3>4.2. Criando a  Requisi√ß√£o - Cadastrar Usuario</h3>



Vamos come√ßar pela requisi√ß√£o Cadastrar Usuario porqu√™ sem um usu√°rio cadastrado n√£o ser√° poss√≠vel autenticar (logar) no sistema e acessar os demais endpoints.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

<div align="center"><img src="https://i.imgur.com/gEzaJVM.png" title="source: imgur.com" /></div>

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.
3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/2199dTU.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo Post o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o nome, o usuario(e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplica√ß√£o retornar√° a senha criptografada.

<div align="center"><img src="https://i.imgur.com/GPIA7LX.png" title="source: imgur.com" /></div>

<br />

<h3>4.3. Criando a Requisi√ß√£o - Autenticar Usuario (Login)</h3>



Usu√°rio persistido, agora vamos efetuar o login no sistema, que nos retornar√° o **Token de Autoriza√ß√£o**, que nos permitir√° consumir os demais endpoints e recursos da aplica√ß√£o.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/sVVW1sF.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/f2NvyEo.png" title="source: imgur.com" /></div>

8. Observe que no JSON estamos passando apenas o usu√°rio e a senha, porqu√™ s√£o as √∫nicas informa√ß√µes que utilizaremos no login. A Classe UsuarioLogin possui outros Atributos que ser√£o preenchidos (exceto a senha) pela aplica√ß√£o (se o login for efetuado com sucesso) e retornados no JSON da resposta, como vemos na figura abaixo:

<div align="center"><img src="https://i.imgur.com/H5gkNzF.png" title="source: imgur.com" /></div>

9. Observe que o Token foi gerado e enviado na resposta. Copie o Token da resposta porqu√™ vamos precisar dele nas pr√≥ximas requisi√ß√µes.

<div align="center"><img src="https://i.imgur.com/GhBcfMt.png" title="source: imgur.com" /></div>

10. Caso o login falhe, voc√™ receber√° o **status 401 (Unauthorized)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/BKbT7S3.png" title="source: imgur.com" /></div>

<br />

<h3>4.4. Criando a  Requisi√ß√£o - Consultar todos os Usuarios - findAll()</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/sHaqXfI.png" title="source: imgur.com" /></div>

6. Como a seguran√ßa foi habilitada, caso voc√™ envie a requisi√ß√£o do jeito que est√°, voc√™ receber√° o **HTTP status 401 (Unauthorized)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/BKbT7S3.png" title="source: imgur.com" /></div>

7. A explica√ß√£o √© simples: **Voc√™ precisa passar no cabe√ßalho da requisi√ß√£o o Token JWT recebido no login**, caso contr√°rio n√£o ser√° poss√≠vel efetuar nenhuma opera√ß√£o dentro da API. 

> [!TIP]
>
> **No frontend, o envio do token de autentica√ß√£o ser√° feito de forma autom√°tica.** Isso significa que, ap√≥s o usu√°rio realizar o login, o token JWT ser√° armazenado e inclu√≠do automaticamente nos cabe√ßalhos das requisi√ß√µes subsequentes, garantindo acesso seguro aos recursos protegidos sem que o usu√°rio precise inserir o token manualmente a cada requisi√ß√£o.

8. Clique na Guia **Headers** e adicione uma nova linha de cabe√ßalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

9. Na coluna **New header** digite **Authorization**. Na coluna **New value** da linha insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/d4MGeap.png" title="source: imgur.com" /></div>

10. Agora a sua requisi√ß√£o funcionar√°!

<br />

> [!WARNING]
>
> √â fundamental inserir o Token JWT no cabe√ßalho de todas as requisi√ß√µes dos recursos **Postagem**, **Tema** e **Usuario** ‚Äî exceto nos endpoints **Cadastrar** e **Autenticar**. Caso o token n√£o seja enviado corretamente, o servidor responder√° com o status **401 Unauthorized**, negando o acesso √†s opera√ß√µes protegidas.

<br />

<h3>4.5. Criando a  Requisi√ß√£o - Consultar Usuario por ID - findById(id)</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/RLUrAOZ.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/tQgQcsz.png" title="source: imgur.com" /></div>

6. Clique na Guia **Header** e adicione uma nova linha de cabe√ßalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

7. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/Izd1nAW.png" title="source: imgur.com" /></div>

<br />

<h3>4.6. Criando a  Requisi√ß√£o - Atualizar Usu√°rio</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Requisi√ß√£o**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endere√ßo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/H5RRlRg.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo **PUT** o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

9. Clique na Guia **Header** e adicione uma nova linha de cabe√ßalho.


<div align="center"><img src="https://i.imgur.com/bRBvX71.png" title="source: imgur.com" /></div>

10. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que voc√™ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 05 - Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem  no Insomnia</h2>



Como habilitamos o Relacionamento entre as Classes Postagem e Usuario, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- O Tema e o Usuario devem ser persistidos antes de criar a nova Postagem.
- Na requisi√ß√£o Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisi√ß√£o deve conter um Objeto da Classe Tema identificado apenas pelo **Atributo id** e um Objeto da Classe Usuario identificado apenas pelo **Atributo id**.

<br />

<h3>5.1. Atualiza√ß√£o - Requisi√ß√£o Cadastrar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/D46gazO.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

> [!WARNING]
>
> O objeto **Usuario** precisa ser persistido no banco de dados antes de ser inclu√≠do no JSON da requisi√ß√£o para **Cadastrar Postagem**. Isso garante que a postagem esteja corretamente vinculada a um usu√°rio existente, evitando erros de integridade e garantindo a consist√™ncia dos dados na aplica√ß√£o.

<br />

<h3>5.2. Atualiza√ß√£o - Requisi√ß√£o Atualizar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/ovpUW1C.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

> [!WARNING]
>
> O objeto **Usuario** precisa ser persistido no banco de dados antes de ser inclu√≠do no JSON da requisi√ß√£o para **Cadastrar Postagem**. Isso garante que a postagem esteja corretamente vinculada a um usu√°rio existente, evitando erros de integridade e garantindo a consist√™ncia dos dados na aplica√ß√£o.

<br />

<div align="center"><h2>IMPORTANTE!</h2></div>

Caso em alguma Requisi√ß√£o com o Token JWT inserido no cabe√ßalho, retorne o **HTTP status 401 (Unauthorized)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/TgJ6aWq.png" title="source: imgur.com" /></div>

**Significa que o Token JWT Expirou!** 

Lembre-se que o **Token JWT foi configurado com um limite de 1 hora** e depois deste per√≠odo ele deixa de funcionar. Refa√ßa o login e atualize o Token de todas as Requisi√ß√µes HTTP.

<br/>

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_spring/tree/11_Spring_Security" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>


<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

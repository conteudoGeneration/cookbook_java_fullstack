<h1>Projeto 02 - Blog Pessoal - Spring Security - Ecossistema do Usuﾃ｡rio - Parte 02</h1>

O que veremos por aqui:

1. A Classe UsuarioService
2. A Classe UsuarioController
3. Testes no Insomnia

Vamos finalizar o Ecossistema do Usuﾃ｡rio.

<br />

<h2>促 Passo 01 - Criar o Pacote Service</h2>

1. Na Guia **Package explorer**, clique com o botﾃ｣o direito do mouse sobre a Package **com.generation.blogpessoal**, na Source Folder **src/main/java** e clique na opﾃｧﾃ｣o  **New ｡ｪ Package**.

2. Na janela **New Java Package**, no item **Name**, acrescente no final do nome da Package **.service** e clique no botﾃ｣o **Finish** para concluir.

<div align="center"><img src="https://i.imgur.com/xTtAHJu.png" title="source: imgur.com" width="65%"/></div>

<br />

<h2>促 Passo 02 - Criar a Classe UsuarioService na Camada Service</h2>

A **Classe UsuarioService** ﾃｩ responsﾃ｡vel por manipular as regras de negﾃｳcio de usuﾃ｡rio no sistema. Esta Classe deve ser anotada com a anotaﾃｧﾃ｣o **@Service**, para que o Spring identifique que ﾃｩ uma Classe que serviﾃｧo. Vale mencionar que alguns Mﾃｩtodos definidos abaixo sﾃ｣o de extrema importﾃ｢ncia para a Spring Security. 

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATENﾃﾃグ:** *O uso da Classe de Serviﾃｧo nﾃ｣o se restringe apenas a Spring Security, ela pode ser utilizada em qualquer endpoint para criar Regras de Negﾃｳcio. Exemplo: Nﾃ｣o permitir postagens ou temas duplicados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o botﾃ｣o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.service**), na Source Folder Principal (**src/main/java**), e clique na opﾃｧﾃ｣o **New ｡ｪ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioService**), e na sequﾃｪncia clique no botﾃ｣o **Finish** para concluir.

A Implementaﾃｧﾃ｣o completa da **Classe UsuarioService**, vocﾃｪ confere abaixo:

```java
package com.generation.blogpessoal.service;

import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.repository.UsuarioRepository;
import com.generation.blogpessoal.security.JwtService;

@Service
public class UsuarioService {

	@Autowired
	private UsuarioRepository usuarioRepository;

	@Autowired
    private JwtService jwtService;

    @Autowired
    private AuthenticationManager authenticationManager;

	public Optional<Usuario> cadastrarUsuario(Usuario usuario) {

		if (usuarioRepository.findByUsuario(usuario.getUsuario()).isPresent())
			return Optional.empty();

		usuario.setSenha(criptografarSenha(usuario.getSenha()));

		return Optional.of(usuarioRepository.save(usuario));
	
	}

	public Optional<Usuario> atualizarUsuario(Usuario usuario) {
		
		if(usuarioRepository.findById(usuario.getId()).isPresent()) {

			Optional<Usuario> buscaUsuario = usuarioRepository.findByUsuario(usuario.getUsuario());

			if ( (buscaUsuario.isPresent()) && ( buscaUsuario.get().getId() != usuario.getId()))
				throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Usuﾃ｡rio jﾃ｡ existe!", null);

			usuario.setSenha(criptografarSenha(usuario.getSenha()));

			return Optional.ofNullable(usuarioRepository.save(usuario));
			
		}

		return Optional.empty();
	
	}	

	public Optional<UsuarioLogin> autenticarUsuario(Optional<UsuarioLogin> usuarioLogin) {
        
        // Gera o Objeto de autenticaﾃｧﾃ｣o
		var credenciais = new UsernamePasswordAuthenticationToken(usuarioLogin.get().getUsuario(), usuarioLogin.get().getSenha());
		
        // Autentica o Usuario
		Authentication authentication = authenticationManager.authenticate(credenciais);
        
        // Se a autenticaﾃｧﾃ｣o foi efetuada com sucesso
		if (authentication.isAuthenticated()) {

            // Busca os dados do usuﾃ｡rio
			Optional<Usuario> usuario = usuarioRepository.findByUsuario(usuarioLogin.get().getUsuario());

            // Se o usuﾃ｡rio foi encontrado
			if (usuario.isPresent()) {

                // Preenche o Objeto usuarioLogin com os dados encontrados 
			   usuarioLogin.get().setId(usuario.get().getId());
                usuarioLogin.get().setNome(usuario.get().getNome());
                usuarioLogin.get().setFoto(usuario.get().getFoto());
                usuarioLogin.get().setToken(gerarToken(usuarioLogin.get().getUsuario()));
                usuarioLogin.get().setSenha("");
				
                 // Retorna o Objeto preenchido
			   return usuarioLogin;
			
			}

        } 
            
		return Optional.empty();

    }

	private String criptografarSenha(String senha) {

		BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
		
		return encoder.encode(senha);

	}

	private String gerarToken(String usuario) {
		return "Bearer " + jwtService.generateToken(usuario);
	}

}
```

Observe que foram criados os Mﾃｩtodos **cadastrarUsuario()** e **atualizarUsuario()**, que criptografam a senha e impedem a duplicaﾃｧﾃ｣o do usuﾃ｡rio no Banco de dados. O Mﾃｩtodo **autenticarUsuario()**, alﾃｩm de autenticar o usuﾃ｡rio no sistema, ele tambﾃｩm gera o **Token JWT** do usuﾃ｡rio.

Foram criados ainda 2 Mﾃｩtodos auxiliares: **criptografarSenha() e gerarToken()**, para realizar funﾃｧﾃｵes especﾃｭficas na Classe de Serviﾃｧo. 

Observe que no Mﾃｩtodo **autenticarUsuario**, para efetuar a autenticaﾃｧﾃ｣o do usuﾃ｡rio foram criados Objetos das Classes **UsernamePasswordAuthenticationToken**, que cria o Objeto de autenticaﾃｧﾃ｣o (credenciais) contendo os dados do usuﾃ｡rio (e-mail e senha) e **Authentication**, que autenticarﾃ｡ o usuﾃ｡rio com o Objeto de autenticaﾃｧﾃ｣o (credenciais), atravﾃｩs do Mﾃｩtodo **authenticationManager.authenticate()**. Para checar se o usuﾃ｡rio foi autenticado corretamente, foi utilizado o Mﾃｩtodo **authentication.isAuthenticated()**, da Classe **Authentication**.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, o cadastro de um novo usuﾃ｡rio no sistema necessita ser validado no Banco de dados. Caso o usuﾃ｡rio jﾃ｡ exista, a aplicaﾃｧﾃ｣o nﾃ｣o deve permitir que ele seja criado novamente, pois um usuﾃ｡rio duplicado no sistema ocasionarﾃ｡ um erro HTTP Status 500.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="200px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, ao atualizar um usuﾃ｡rio ﾃｩ importante que seja validado novamente a criptografia da senha e o usuﾃ｡rio (e-mail). Caso nﾃ｣o seja validado ocasionarﾃ｡ um problema ao tentar autenticar pelo front-end da aplicaﾃｧﾃ｣o.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, ao utilizar o Mﾃｩtodo autenticarUsuario, certifique que todos os Atributos do Objeto usuarioLogin, exceto a senha, sejam preenchidos com os dados recuperados do Banco de dados, pois o mesmo serﾃ｡ utilizado pelo front-end da aplicaﾃｧﾃ｣o.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, ao construir o Mﾃｩtodo gerarToken. Observe que apﾃｳs a palavra Bearer ﾃｩ obrigatﾃｳrio adicionar um espaﾃｧo em branco, caso contrﾃ｡rio o Token JWT nﾃ｣o serﾃ｡ validado pela Classe JwtService.** </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Para concluir, nﾃ｣o esqueﾃｧa de Salvar o cﾃｳdigo (**File ｡ｪ Save All**).

<br />

<div align="left"><img src="https://i.imgur.com/wDz2IzB.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/stereotype/Service.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>@Service</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/9B46Slv.png" title="source: imgur.com" width="3%"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>BCryptPasswordEncoder - Java Doc Spring</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="30px"/> <a href="https://docs.google.com/document/d/1IQwgepFjSVCsMWiLHCidJyAj3jF2xp5h/edit" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Optional</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/wMe2uG1.png" title="source: imgur.com" width="30px"/> <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/throwing.html" target="_blank"><b>Documentaﾃｧﾃ｣o: Throw</b></a></div>

<br />


<h2>促 Passo 03 - Criar a Classe UsuarioController na Camada Controller</h2>

A Classe **UsuarioController**, ﾃｩ responsﾃ｡vel por fornecer o acesso aos recursos do sistema. Uma das suas funcionalidades abaixo ﾃｩ promover o CRUD do usuﾃ｡rio. Alﾃｩm de permitir total manipulaﾃｧﾃ｣o do usuﾃ｡rio, consumindo os serviﾃｧos cadastrar usuﾃ｡rio, atualizar usuﾃ｡rio e autenticar da Classe UsuarioService.

1. Clique com o botﾃ｣o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.controller**), na Source Folder Principal (**src/main/java**), e clique na opﾃｧﾃ｣o **New ｡ｪ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioController**), e na sequﾃｪncia clique no botﾃ｣o **Finish** para concluir.

A seguir veja sua implementaﾃｧﾃ｣o:

```java
package com.generation.blogpessoal.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.generation.blogpessoal.model.UsuarioLogin;
import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.repository.UsuarioRepository;
import com.generation.blogpessoal.service.UsuarioService;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/usuarios")
@CrossOrigin(origins = "*", allowedHeaders = "*")
public class UsuarioController {

	@Autowired
	private UsuarioService usuarioService;

	@Autowired
	private UsuarioRepository usuarioRepository;
	
	@GetMapping("/all")
	public ResponseEntity <List<Usuario>> getAll(){
		
		return ResponseEntity.ok(usuarioRepository.findAll());
		
	}

	@GetMapping("/{id}")
	public ResponseEntity<Usuario> getById(@PathVariable Long id) {
		return usuarioRepository.findById(id)
			.map(resposta -> ResponseEntity.ok(resposta))
			.orElse(ResponseEntity.notFound().build());
	}
	
	@PostMapping("/logar")
	public ResponseEntity<UsuarioLogin> autenticarUsuario(@RequestBody Optional<UsuarioLogin> usuarioLogin){
		
		return usuarioService.autenticarUsuario(usuarioLogin)
				.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
				.orElse(ResponseEntity.status(HttpStatus.UNAUTHORIZED).build());
	}
    

	@PostMapping("/cadastrar")
	public ResponseEntity<Usuario> postUsuario(@RequestBody @Valid Usuario usuario) {

		return usuarioService.cadastrarUsuario(usuario)
			.map(resposta -> ResponseEntity.status(HttpStatus.CREATED).body(resposta))
			.orElse(ResponseEntity.status(HttpStatus.BAD_REQUEST).build());

	}

	@PutMapping("/atualizar")
	public ResponseEntity<Usuario> putUsuario(@Valid @RequestBody Usuario usuario) {
		
		return usuarioService.atualizarUsuario(usuario)
			.map(resposta -> ResponseEntity.status(HttpStatus.OK).body(resposta))
			.orElse(ResponseEntity.status(HttpStatus.NOT_FOUND).build());
		
	}

}
```

Observe que nos Mﾃｩtodos Cadastrar, Atualizar e Autenticar, ao invﾃｩs de usarmos a injeﾃｧﾃ｣o de dependﾃｪncia da Interface UsuarioRepository, estamos utilizando a injeﾃｧﾃ｣o de dependﾃｪncia da Classe de Serviﾃｧo **UsuarioService** porquﾃｪ os 3 Mﾃｩtodos foram implementados nela.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left">ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, nos Mﾃｩtodos postUsuario e putUsuario para nﾃ｣o esquecer a notaﾃｧﾃ｣o @Valid. Caso ela nﾃ｣o seja inserida, ao fornecer parﾃ｢metros invﾃ｡lidos, o servidor retornarﾃ｡ o HTTP Status 500, ao invﾃｩs do HTTP Status 400.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Para concluir, nﾃ｣o esqueﾃｧa de Salvar o cﾃｳdigo (**File ｡ｪ Save All**).

<br />


<h2>促 Passo 04 - Testar o Recurso Usuario no Insomnia</h2>

Vamos criar no Insomnia todas as requisiﾃｧﾃｵes necessﾃ｡rias para testar os 5 Mﾃｩtodos do Recurso Usuario. Veja abaixo como ficam as requisiﾃｧﾃｵes para testar o Recurso Usuario:

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso vocﾃｪ tenha alguma dﾃｺvida sobre como criar as Requisiﾃｧﾃｵes, consulte a Documentaﾃｧﾃ｣o dos Recursos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <div align="left"> **ATENﾃﾃグ:** *Depois de criar o Relacionamento entre Classes, todas as Consultas dos Recursos Postagem, Tema e Usuario trarﾃ｣o os Objetos associados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>4.1. Criando a Pasta Usuario</h3>

Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardarﾃ｡ todas as requisiﾃｧﾃｵes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no botﾃ｣o <img src="https://i.imgur.com/3Ou2SAZ.png" title="source: imgur.com" width="6%"/>. No menu que serﾃ｡ aberto, clique na opﾃｧﾃ｣o **New Folder**.

<div align="center"><img src="https://i.imgur.com/gIGZFHc.png" title="source: imgur.com" width="50%"/></div>

2. Na janela que serﾃ｡ aberta, informe o nome da pasta (**Usuario**) e clique no botﾃ｣o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/etf4wwv.png" title="source: imgur.com" width="90%"/></div>

<br />

<h3>4.2. Criando a  Requisiﾃｧﾃ｣o - Cadastrar Usuario</h3>

Vamos comeﾃｧar pela requisiﾃｧﾃ｣o Cadastrar Usuario porquﾃｪ sem um usuﾃ｡rio cadastrado nﾃ｣o serﾃ｡ possﾃｭvel autenticar (logar) no sistema e acessar os demais endpoints.

1. Clique com o botﾃ｣o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na opﾃｧﾃ｣o **New Request**.

<div align="center"><img src="https://i.imgur.com/gEzaJVM.png" title="source: imgur.com" /></div>

2. Serﾃ｡ criada uma nova Requisiﾃｧﾃ｣o (New Request) dentro da pasta **Usuario**.
3. Dﾃｪ um duplo clique sobre a nova requisiﾃｧﾃ｣o (**New Request**), informe o nome da requisiﾃｧﾃ｣o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o Mﾃｩtodo HTTP que serﾃ｡ utilizado (**POST**) na requisiﾃｧﾃ｣o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisiﾃｧﾃ｣o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** serﾃ｡ renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisiﾃｧﾃ｣o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/2199dTU.png" title="source: imgur.com" /></div>

8. Observe que na requisiﾃｧﾃ｣o do tipo Post o Corpo da requisiﾃｧﾃ｣o (Request Body), deve ser preenchido com um JSON contendo o nome, o usuario(e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplicaﾃｧﾃ｣o retornarﾃ｡ a senha criptografada.

<div align="center"><img src="https://i.imgur.com/GPIA7LX.png" title="source: imgur.com" /></div>

<br />

<h3>4.3. Criando a Requisiﾃｧﾃ｣o - Autenticar Usuario (Login)</h3>

Usuﾃ｡rio persistido, agora vamos efetuar o login no sistema, que nos retornarﾃ｡ o **Token de Autorizaﾃｧﾃ｣o**, que nos permitirﾃ｡ consumir os demais endpoints e recursos da aplicaﾃｧﾃ｣o.

1. Clique com o botﾃ｣o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na opﾃｧﾃ｣o **New Request**.

2. Serﾃ｡ criada uma nova Requisiﾃｧﾃ｣o (New Request) dentro da pasta **Usuario**.

3. Dﾃｪ um duplo clique sobre a nova requisiﾃｧﾃ｣o (**New Request**), informe o nome da requisiﾃｧﾃ｣o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/sVVW1sF.png" title="source: imgur.com" /></div>

4. Selecione o Mﾃｩtodo HTTP que serﾃ｡ utilizado (**POST**) na requisiﾃｧﾃ｣o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisiﾃｧﾃ｣o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** serﾃ｡ renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisiﾃｧﾃ｣o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/f2NvyEo.png" title="source: imgur.com" /></div>

8. Observe que no JSON estamos passando apenas o usuﾃ｡rio e a senha, porquﾃｪ sﾃ｣o as ﾃｺnicas informaﾃｧﾃｵes que utilizaremos no login. A Classe UsuarioLogin possui outros Atributos que serﾃ｣o preenchidos (exceto a senha) pela aplicaﾃｧﾃ｣o (se o login for efetuado com sucesso) e retornados no JSON da resposta, como vemos na figura abaixo:

<div align="center"><img src="https://i.imgur.com/H5gkNzF.png" title="source: imgur.com" /></div>

9. Observe que o Token foi gerado e enviado na resposta. Copie o Token da resposta porquﾃｪ vamos precisar dele nas prﾃｳximas requisiﾃｧﾃｵes.

<div align="center"><img src="https://i.imgur.com/GhBcfMt.png" title="source: imgur.com" /></div>

10. Caso o login falhe, vocﾃｪ receberﾃ｡ o **status 403 (Forbidden)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/PxmSjdZ.png" title="source: imgur.com" /></div>

11. Observe que na propriedade **trace** (indicada pela seta), foi lanﾃｧada a Exceﾃｧﾃ｣o **Bad Credentials**, ou seja, usuario e/ou senha incorretos.

<br />

<h3>4.4. Criando a  Requisiﾃｧﾃ｣o - Consultar todos os Usuarios - findAll()</h3>

1. Clique com o botﾃ｣o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na opﾃｧﾃ｣o **New Request**.

2. Serﾃ｡ criada uma nova Requisiﾃｧﾃ｣o (New Request) dentro da pasta **Usuario**.

3. Dﾃｪ um duplo clique sobre a nova requisiﾃｧﾃ｣o (**New Request**), informe o nome da requisiﾃｧﾃ｣o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o Mﾃｩtodo HTTP que serﾃ｡ utilizado (**GET**) na requisiﾃｧﾃ｣o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisiﾃｧﾃ｣o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/sHaqXfI.png" title="source: imgur.com" /></div>

6. Como a seguranﾃｧa foi habilitada, caso vocﾃｪ envie a requisiﾃｧﾃ｣o do jeito que estﾃ｡, vocﾃｪ receberﾃ｡ o **HTTP status 401 (Unauthorized)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/tP6IoZJ.png" title="source: imgur.com" /></div>

7. A explicaﾃｧﾃ｣o ﾃｩ simples: **Vocﾃｪ precisa passar no cabeﾃｧalho da requisiﾃｧﾃ｣o o Token JWT recebido no login**, caso contrﾃ｡rio nﾃ｣o serﾃ｡ possﾃｭvel efetuar nenhuma operaﾃｧﾃ｣o dentro da API. 

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <div align="left"> **ATENﾃﾃグ:** *No Frontend, independente de ser implementado no Angular ou no React, a passagem do Token serﾃ｡ automatizada.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

8. Clique na Guia **Headers** e adicione uma nova linha de cabeﾃｧalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

9. Na coluna **New header** digite **Authorization**. Na coluna **New value** da linha insira o **Token JWT** que vocﾃｪ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/d4MGeap.png" title="source: imgur.com" /></div>

10. Agora a sua requisiﾃｧﾃ｣o funcionarﾃ｡!

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left">ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes! Vocﾃｪ deverﾃ｡ inserir o Token JWT no cabeﾃｧalho de todas as Requisiﾃｧﾃｵes dos Recursos Postagem, Tema e Usuario (Exceto Cadastrar e Autenticar), caso contrﾃ｡rio vocﾃｪ receberﾃ｡ o status 401 (Unauthorized) em todas elas.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>4.5. Criando a  Requisiﾃｧﾃ｣o - Consultar Usuario por ID - findById(id)</h3>

1. Clique com o botﾃ｣o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na opﾃｧﾃ｣o **New Request**.

2. Serﾃ｡ criada uma nova Requisiﾃｧﾃ｣o (New Request) dentro da pasta **Usuario**.

3. Dﾃｪ um duplo clique sobre a nova requisiﾃｧﾃ｣o (**New Request**), informe o nome da requisiﾃｧﾃ｣o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/RLUrAOZ.png" title="source: imgur.com" /></div>

4. Selecione o Mﾃｩtodo HTTP que serﾃ｡ utilizado (**GET**) na requisiﾃｧﾃ｣o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisiﾃｧﾃ｣o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/tQgQcsz.png" title="source: imgur.com" /></div>

6. Clique na Guia **Header** e adicione uma nova linha de cabeﾃｧalho.

<div align="center"><img src="https://i.imgur.com/gEll9dH.png" title="source: imgur.com" /></div>

7. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que vocﾃｪ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/Izd1nAW.png" title="source: imgur.com" /></div>

<br />

<h3>4.6. Criando a  Requisiﾃｧﾃ｣o - Atualizar Usuﾃ｡rio</h3>

1. Clique com o botﾃ｣o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na opﾃｧﾃ｣o **New Requisiﾃｧﾃ｣o**.

2. Serﾃ｡ criada uma nova Requisiﾃｧﾃ｣o (New Request) dentro da pasta **Usuario**.

3. Dﾃｪ um duplo clique sobre a nova requisiﾃｧﾃ｣o (**New Request**), informe o nome da requisiﾃｧﾃ｣o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o Mﾃｩtodo HTTP que serﾃ｡ utilizado (**PUT**) na requisiﾃｧﾃ｣o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisiﾃｧﾃ｣o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** serﾃ｡ renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endereﾃｧo da requisiﾃｧﾃ｣o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/H5RRlRg.png" title="source: imgur.com" /></div>

8. Observe que na requisiﾃｧﾃ｣o do tipo **PUT** o Corpo da requisiﾃｧﾃ｣o (Request Body), deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

9. Clique na Guia **Header** e adicione uma nova linha de cabeﾃｧalho.


<div align="center"><img src="https://i.imgur.com/bRBvX71.png" title="source: imgur.com" /></div>

10. Na coluna **New header** digite **Authorization**. Na coluna **New value** insira o **Token JWT** que vocﾃｪ recebeu no Login, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

<h2>促 Passo 05 - Atualizar as Requisiﾃｧﾃｵes Cadastrar e Atualizar Postagem  no Insomnia</h2>

Como habilitamos o Relacionamento entre as Classes Postagem e Usuario, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- O Tema e o Usuario devem ser persistidos antes de criar a nova Postagem.
- Na requisiﾃｧﾃ｣o Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisiﾃｧﾃ｣o deve conter um Objeto da Classe Tema identificado apenas pelo **Atributo id** e um Objeto da Classe Usuario identificado apenas pelo **Atributo id**.

<br />

<h3>5.1. Atualizaﾃｧﾃ｣o - Requisiﾃｧﾃ｣o Cadastrar Postagem</h3>

Vamos alterar o Corpo da requisiﾃｧﾃ｣o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/D46gazO.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, alﾃｩm do Objeto da Classe Tema, que foi inserido anteriormente.

Nﾃ｣o esqueﾃｧa de inserir o token no cabeﾃｧalho da requisiﾃｧﾃ｣o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATENﾃﾃグ:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisiﾃｧﾃ｣o Cadastrar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>5.2. Atualizaﾃｧﾃ｣o - Requisiﾃｧﾃ｣o Atualizar Postagem</h3>

Vamos alterar o Corpo da requisiﾃｧﾃ｣o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/ovpUW1C.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, alﾃｩm do Objeto da Classe Tema, que foi inserido anteriormente.

Nﾃ｣o esqueﾃｧa de inserir o token no cabeﾃｧalho da requisiﾃｧﾃ｣o.

<div align="center"><img src="https://i.imgur.com/GJq6oCf.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATENﾃﾃグ:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisiﾃｧﾃ｣o Atualizar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="center"><h2>IMPORTANTE!</h2></div>

Caso em alguma Requisiﾃｧﾃ｣o com o Token JWT inserido no cabeﾃｧalho, retorne o **HTTP status 403 (Forbidden)**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/RagAaMk.png" title="source: imgur.com" /></div>

**Significa que o Token JWT Expirou!** 

Lembre-se que o **Token JWT foi configurado com um limite de 1 hora** e depois deste perﾃｭodo ele deixa de funcionar. Refaﾃｧa o login e atualize o Token de todas as Requisiﾃｧﾃｵes HTTP.

<br/>

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_v3/tree/14_Classe_UsuarioService" target="_blank"><b>Cﾃｳdigo fonte do projeto</b></a></div>


<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

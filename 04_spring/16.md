<h1>Projeto 02 - Blog Pessoal - Spring Security - Ecossistema do Usu√°rio - Parte 01</h1>

O que veremos por aqui:

1. O Ecossistema do Usu√°rio
2. Apresenta√ß√£o do Recurso Usu√°rio
3. Criar a Classe Model Usuario relacionada com a Classe Postagem
4. Criar a Classe UsuarioLogin
5. Criar a Interface UsuarioRepository

<br />

<h2>1. Ecossistema do Usuario</h2>

O Ecossistema do Usuario √© a parte respons√°vel por definir os dados do nosso Objeto Usuario, que ser√° utilizado para autenticar e autorizar o acesso ao Blog Pessoal, quando a camada de seguran√ßa da aplica√ß√£o estiver completamente implementada.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** Aproveite esta etapa para validar seu c√≥digo do Blog Pessoal, o projeto abaixo serve como espelho para o Projeto Integrador. Tenha bastante aten√ß√£o aos detalhes, pois existem implementa√ß√µes fundamentais para o perfeito funcionamento do sistema. Caso surjam d√∫vidas, n√£o hesite em buscar os Instrutores da Generation para obter orienta√ß√µes.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>2. O Recurso Usuario</h2>

Nesta etapa vamos come√ßar a construir o Recurso Usuario, que ser√° composto por 2 Classes: **Usuario** e **Usuario Login**. 

<div align="center"><img src="https://i.imgur.com/1OVel2T.png" title="source: imgur.com" width="70%"/></div>

A **Classe Usuario** servir√° de modelo para construir a tabela **tb_usuarios** (Entidade) dentro do nosso Banco de dados **db_blogpessoal**. Os campos (Atributos) da tabela ser√£o os mesmos que est√£o definidos no Diagrama de Classes acima.

Depois de criar a Classe Model Usuario, vamos executar o projeto Blog Pessoal no STS. Ap√≥s a execu√ß√£o veremos que ser√° criado no Banco de dados db_blogpessoal a tabela tb_usuarios. Veja abaixo como ficar√° a estrutura da nossa tabela atrav√©s do Diagrama de Entidade e Relacionamentos (DER):

<div align="center"><img src="https://i.imgur.com/txYWVNR.png" title="source: imgur.com" width="50%"/></div>

O Dicion√°rio de dados da nossa tabela **tb_Usuarios** ser√° o seguinte:

| Atributo | Tipo de dado  | Descri√ß√£o           | Chave |
| -------- | ------------- | ------------------- | ----- |
| **id**   | bigint        | Identificador √∫nico | PK    |
| nome     | varchar(255)  | Nome do usu√°rio     |       |
| usuario  | varchar(255)  | E-mail do usu√°rio   |       |
| senha    | varchar(255)  | Senha do usu√°rio    |       |
| foto     | varchar(5000) | Foto do usu√°rio     |       |

Al√©m de construirmos a Classe Usuario, tamb√©m faremos o Relacionamento com a Classe Postagem, constru√≠da anteriormente. Veja como ficar√° o Relacionamento entre as 3 Classes, ap√≥s a implementa√ß√£o, no Diagrama de Classes abaixo:

<div align="center"><img src="https://i.imgur.com/5p6IKku.png" title="source: imgur.com" /></div>

Depois de criar a Classe Model Usuario e o Relacionamento com a Classe Postagem, a estrutura do nosso Banco de dados **db_blogpessoal** ficar√° igual ao **Diagrama de Entidade e Relacionamentos (DER)** abaixo:

<div align="center"><img src="https://i.imgur.com/mLIEhuA.png" title="source: imgur.com" /></div>

Observe que a entidade Postagem (tb_postagens) passar√° a ter **2 Chaves Estrangeiras (FK)**: *tema_id e usuario_id*.

Na sequ√™ncia vamos construir a **Interface UsuarioRepository**, que ir√° nos auxiliar na intera√ß√£o com o Banco de dados e com as Classes **UsuarioController**, onde ser√£o implementados os 5 M√©todos descritos no Diagrama de Classes acima e com a Classe de Servi√ßo (Service), **UsuarioService**, onde ser√£o implementadas as **Regras de Neg√≥cio** exigidas pela **Spring Security**.

O Diagrama de Classes da nossa Interface **UsuarioRepository** ser√° igual a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/MdU4eSa.png" title="source: imgur.com" width="50%"/></div>

Observe que na Interface UsuarioRepository, a Query Method que ser√° constru√≠da √© diferente dos M√©todos Constru√≠dos nas Interfaces **PostagemRepository e TemaRepository**.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o Recurso Usuario. Todas as Camadas (Pacotes: Model, Repository e Controller), j√° foram criadas nos Recursos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar a Classe, executar o projeto, entre outras, consulte a Documenta√ß√£o dos outros Recursos.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Tamb√©m vamos criar a **Classe Usuario Login**, que embora seja criada na **Camada Model**, ela n√£o ir√° gerar uma tabela no Banco de dados. Esta Classe ser√° uma Classe auxiliar para o usu√°rio efetuar login no sistema. 

<div align="center"><img src="https://i.imgur.com/8JIcXQN.png" title="source: imgur.com" width="60%"/></div>

<br />

<h2>üë£ Passo 01 - Inserir as Depend√™ncias </h2>

No arquivo, **pom.xml**, adicione as linhas abaixo (caso voc√™ ainda n√£o tenha adicionado):

```xml
<!-- Depend√™ncia da Spring Security -->
<dependency>  
	<groupId>org.springframework.boot</groupId>  
	<artifactId>spring-boot-starter-security</artifactId>  
</dependency>
<!-- Depend√™ncias para Gera√ß√£o e Valida√ß√£o do Token JWT -->
<dependency>
	<groupId>io.jsonwebtoken</groupId>
	<artifactId>jjwt-api</artifactId>
	<version>0.11.5</version>
</dependency>
<dependency>
	<groupId>io.jsonwebtoken</groupId>
	<artifactId>jjwt-impl</artifactId>
	<version>0.11.5</version>
</dependency>
<dependency>
	<groupId>io.jsonwebtoken</groupId>
	<artifactId>jjwt-jackson</artifactId>
	<version>0.11.5</version>
</dependency>
```

A primeira depend√™ncia, n√≥s adicionamos na introdu√ß√£o da Spring Security. As outras 3 s√£o respons√°veis por gerar e validar o Token JWT.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left">**ATEN√á√ÉO:** No momento em que este conte√∫do foi escrito, a vers√£o atual da Depend√™ncia JWT era 0.11.5. Ao acessar este conte√∫do a vers√£o mais atual da Depend√™ncia pode ser outra.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />
	
Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />


<h2>üë£ Passo 02 - Criar a Classe Usuario na Camada Model</h2>

Agora vamos criar a terceira Classe Model que chamaremos de **Usuario**.

1. Clique com o bot√£o direito do mouse sobre o **Pacote Model** (**com.generation.blogpessoal.model**), na Source Folder Principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**Usuario**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.  


A seguir veja a implementa√ß√£o completa da **Classe Usuario**:

```java
package com.generation.blogpessoal.model;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.OneToMany;
import jakarta.persistence.Table;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

@Entity
@Table(name = "tb_usuarios")
public class Usuario {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@NotBlank(message = "O Atributo Nome √© Obrigat√≥rio!")
	private String nome;

	@NotBlank(message = "O Atributo Usu√°rio √© Obrigat√≥rio!")
	@Email(message = "O Atributo Usu√°rio deve ser um email v√°lido!")
	private String usuario;

	@NotBlank(message = "O Atributo Senha √© Obrigat√≥rio!")
	@Size(min = 8, message = "A Senha deve ter no m√≠nimo 8 caracteres")
	private String senha;

	@Size(max = 5000, message = "O link da foto n√£o pode ser maior do que 5000 caracteres")
	private String foto;

	@OneToMany(fetch = FetchType.LAZY, mappedBy = "usuario", cascade = CascadeType.REMOVE)
	@JsonIgnoreProperties("usuario")
	private List<Postagem> postagem;

	/* Insira os Getters and Setters */

	public Long getId() {
		return this.id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getNome() {
		return this.nome;
	}

	public void setNome(String nome) {
		this.nome = nome;
	}

	public String getUsuario() {
		return this.usuario;
	}

	public void setUsuario(String usuario) {
		this.usuario = usuario;
	}

	public String getSenha() {
		return this.senha;
	}

	public void setSenha(String senha) {
		this.senha = senha;
	}

	public String getFoto() {
		return this.foto;
	}

	public void setFoto(String foto) {
		this.foto = foto;
	}

	public List<Postagem> getPostagem() {
		return this.postagem;
	}

	public void setPostagem(List<Postagem> postagem) {
		this.postagem = postagem;
	}

}
```

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="200px"/> | <div align="left"> ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, o Atributo senha definido acima, n√£o pode conter o Atributo size max, que limita seu tamanho m√°ximo. Dependendo do limite inserido, pode provocar um erro HTTP Status 500, devido ao limite de caracteres que ser√£o utilizados na criptografia. Configure apenas a propriedade size min.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />


Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />

<h2>üë£ Passo 03 - Criar a Rela√ß√£o ManytoOne na Classe Postagem</h2>

A Classe Postagem ser√° o lado N:1, ou seja, **Muitas Postagens podem ter apenas Um Usuario**. Para criar a Rela√ß√£o vamos inserir depois do √∫ltimo Atributo da Classe Postagem (tema), as 3 linhas abaixo:

```java
	@ManyToOne
	@JsonIgnoreProperties("postagem")
	private Usuario usuario;
```

N√£o esque√ßa de acrescentar os **M√©todos Get e Set** para o novo Atributo (usuario), que foi adicionado na Classe Postagem. Veja o c√≥digo completo abaixo:

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="150px"/> | <div align="left"> **DICA:** *Toda vez que voc√™ adicionar um novo Atributo na sua Classe, n√£o esque√ßa de criar os M√©todos GET e SET do Atributo. Caso contr√°rio, voc√™ n√£o conseguir√° visualizar ou atualizar os dados do Atributo.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

A seguir veja a implementa√ß√£o completa da **Classe Postagem** com as altera√ß√µes:
```java
package com.generation.blogpessoal.model;

import java.time.LocalDateTime;

import org.hibernate.annotations.UpdateTimestamp;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

@Entity
@Table(name = "tb_postagens")
public class Postagem {
    
    @Id
	@GeneratedValue(strategy = GenerationType.IDENTITY) 
	private Long id;
	
	@NotBlank(message = "O atributo t√≠tulo √© Obrigat√≥rio!") 
	@Size(min = 5, max = 100, message = "O atributo t√≠tulo deve conter no m√≠nimo 05 e no m√°ximo 100 caracteres")
	private String titulo;
	
	@NotBlank(message = "O atributo texto √© Obrigat√≥rio!")
	@Size(min = 10, max = 1000, message = "O atributo texto deve conter no m√≠nimo 10 e no m√°ximo 1000 caracteres")
	private String texto;
	
	@UpdateTimestamp
	private LocalDateTime data;
	
	@ManyToOne
	@JsonIgnoreProperties("postagem")
	private Tema tema;
	
	@ManyToOne
	@JsonIgnoreProperties("postagem")
	private Usuario usuario;

    public Long getId() {
        return this.id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitulo() {
        return this.titulo;
    }

    public void setTitulo(String titulo) {
        this.titulo = titulo;
    }

    public String getTexto() {
        return this.texto;
    }

    public void setTexto(String texto) {
        this.texto = texto;
    }

    public LocalDateTime getData() {
        return this.data;
    }

    public void setData(LocalDateTime data) {
        this.data = data;
    }

	public Tema getTema() {
		return tema;
	}

	public void setTema(Tema tema) {
		this.tema = tema;
	}

	public Usuario getUsuario() {
		return usuario;
	}

	public void setUsuario(Usuario usuario) {
		this.usuario = usuario;
	}
    
}
```

<br />
	
Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />


<h2>üë£ Passo 04 - Criar a Classe UsuarioLogin na Camada Model</h2>

Agora vamos criar a quarta Classe Model que chamaremos de **UsuarioLogin**.

A Classe **UsuarioLogin** √© respons√°vel por definir que o cliente ao tentar autenticar (fazer login) no sistema, forne√ßa apenas o usu√°rio (e-mail) e a senha. Essa Classe funcionar√° como uma DTO (*Data trasfer object*), que √© uma Classe que √© utilizada para transitar dados do sistema sem revelar sua Classe Model para o cliente. 

1. Clique com o bot√£o direito do mouse sobre o **Pacote Model** (**com.generation.blogpessoal.model**), na Source Folder Principal (**src/main/java**), e clique na op√ß√£o **New ü°™ Class**
3. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UsuarioLogin**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

A seguir veja a implementa√ß√£o completa da **Classe UsuarioLogin**:

```java
package com.generation.blogpessoal.model;

public class UsuarioLogin {
	
	private Long id;
	private String nome;
	private String usuario;
	private String senha;
	private String foto;
	private String token;

	public Long getId() {
		return this.id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getNome() {
		return this.nome;
	}

	public void setNome(String nome) {
		this.nome = nome;
	}

	public String getUsuario() {
		return this.usuario;
	}

	public void setUsuario(String usuario) {
		this.usuario = usuario;
	}

	public String getSenha() {
		return this.senha;
	}

	public void setSenha(String senha) {
		this.senha = senha;
	}

	public String getFoto() {
		return this.foto;
	}

	public void setFoto(String foto) {
		this.foto = foto;
	}

	public String getToken() {
		return this.token;
	}

	public void setToken(String token) {
		this.token = token;
	}

}
```

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, n√£o se esque√ßa de passar o id do usuario como Atributo da Classe, pois este Atributo ser√° utilizado como crdencial pelo front-end para pegar o usuario pelo id. Todos os Atributos presentes na Classe Model Usuario devem estar presentes na Classe UsuarioLogin.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="120px"/> | **ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, n√£o esque√ßa de adicionar o Atributo token, pois o mesmo ser√° passado no cabe√ßalho de todas as requisi√ß√µes do front-end. Este Atributo √© fundamental para consumir a API.** |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />
	
Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />

<h2>üë£ Passo 05 - Executar o projeto e Checar o Banco de dados</h2>

1. Execute o projeto e verifique no **MySQL Workbench** se a tabela **tb_usuarios** foi criada no Banco de dados **db_blogpessoal** com o respectivo relacionamento com a tabela **tb_postagens**, onde foi criada a Chave Estrangeira **usuario_id**.

<div align="center"><img src="https://i.imgur.com/o3Ul8iS.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 06 - Criar a Interface UsuarioRepository na Camada Repository</h2>

Agora vamos criar a Interface Repository que chamaremos de **UsuarioRepository**.

1. Clique com o bot√£o direito do mouse sobre o **Pacote Repository** (**com.generation.blogpessoal.repository**), na Source Folder Principal (**src/main/java**)
	
2. Na sequ√™ncia, clique na op√ß√£o **New ü°™ Interface**

3. Na janela **New Java Interface**, no item **Name**, digite o nome da Interface (**UsuarioRepository**), e na sequ√™ncia clique no bot√£o **Finish** para concluir.

<br />

A seguir veja a implementa√ß√£o completa da **Interface UsuarioRepository**:

```java
package com.generation.blogpessoal.repository;

import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;

import com.generation.blogpessoal.model.Usuario;

public interface UsuarioRepository extends JpaRepository<Usuario, Long>{

	public Optional<Usuario> findByUsuario(String usuario);
	
}
```

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left">ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes, tome muito cuidado pois se a escrita dos M√©todos findBy ou findAllBy estiver errada, pode aparecer um erro no console do STS.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Observe que foi criada uma Query Method na Interface UsuarioRepository, conforme detalhado abaixo:

**Query Method**

```java
public Optional<Usuario> findByUsuario(String usuario);
```

**Instru√ß√£o SQL equivalente**

```sql
SELECT * FROM tb_usuario WHERE usuario = "usuarios";
```

| Palavra            |      | Instru√ß√£o SQL                                                |
| ------------------ | ---- | ------------------------------------------------------------ |
| **find**           | ü°™    | SELECT                                                       |
| **By**             | ü°™    | WHERE                                                        |
| **Usuario**        | ü°™    | Atributo da Classe Usuario                                   |
| **String usuario** | ü°™    | Par√¢metro do M√©todo contendo o e-mail do usu√°rio que voc√™ deseja procurar. |

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *A instru√ß√£o FROM tb_usuarios ser√° inserida pelo JPA ao checar o nome da tabela gerada pela Classe Usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />
	
Para concluir, n√£o esque√ßa de Salvar o c√≥digo (**File ü°™ Save All**).

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_v3/tree/12_Classe_Usuario_Relacionamentos" target="_blank"><b>C√≥digo fonte do Projeto</b></a></div>

<br /><br />

<h2 id="anexo1">Anexo I - Principais Mensagens de Erro</h2>

| Erro                        | Descri√ß√£o                                                    |
| --------------------------- | ------------------------------------------------------------ |
| ***BeanCreationException*** | Ao criar o Relacionamento Bidirecional, voc√™ criou apenas um lado da Rela√ß√£o (**@OneToMany**). Faltou criar o outro lado da Rela√ß√£o (**@ManyToOne**).<br />**Exemplo:** <br/>Habilitou o Relacionamento na Classe Tema, mas n√£o habilitou na Classe Postagem. |

<br /><br />


<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

<h1>Projeto 02 - Blog Pessoal - Spring Security - Ecossistema da Seguranﾃｧa</h1>

O que veremos por aqui:

1. O Ecossistema da Seguranﾃｧa
2. A Classe UserDetailsImpl
3. A Classe UserDetailsServiceImpl
4. A Classe BasicSecurityConfig

Antes de finalizarmos o Ecossistema do Usuﾃ｡rio, vamos compreender e implementar o **Ecossistema da Seguranﾃｧa**, porquﾃｪ utilizaremos alguns Mﾃｩtodos deste ecossistema na implementaﾃｧﾃ｣o das **Classes UsuarioService e UsuarioController**.

<h2>1.  Ecossistema da Seguranﾃｧa</h2>

<div align="center"><img src="https://i.imgur.com/0pHAkL3.png" title="source: imgur.com" /></div>

No Diagrama de Classes acima, ﾃｩ possﾃｭvel visualizar por completo o ecossistema da Seguranﾃｧa, que representa uma das principais implementaﾃｧﾃｵes da Spring Security. Nesta implementaﾃｧﾃ｣o ﾃｩ possﾃｭvel realizar a autenticaﾃｧﾃ｣o do usuﾃ｡rio a partir de um Banco de dados. Para isso ﾃｩ necessﾃ｡rio enviar as informaﾃｧﾃｵes necessﾃ｡rias (usuario e senha) para que o Spring Security valide a permissﾃ｣o do usuﾃ｡rio no sistema. 

O ecossistema de seguranﾃｧa ﾃｩ composto por 3 Classes:

- **BasicSecurityConfig**

- **UserDetailsService**

- **UserDetailsImpl** 

A cor de cada uma das Classes no Diagrama de Classes acima representa o pacote onde cada uma deve ser implementada, segundo informaﾃｧﾃｵes da legenda. Para este Diagrama de Classes, repare que a Classe Model do **Usuario** e a Interface **Repository do Usuario** jﾃ｡ foram criadas no Ecossistema do Usuﾃ｡rio. Para melhor compreensﾃ｣o das relaﾃｧﾃｵes entre as Classes veja uma breve definiﾃｧﾃ｣o sobre as relaﾃｧﾃｵes entre os Objetos:

<div align="center"><img src="https://i.imgur.com/IGtJRbG.jpg" title="source: imgur.com" width="50%"/></div>

| Relaﾃｧﾃ｣o           | Descriﾃｧﾃ｣o                                                    |
| ----------------- | ------------------------------------------------------------ |
| **Dependﾃｪncia**   | Classe A pode ser afetada por mudanﾃｧas na Classe B;          |
| **Associaﾃｧﾃ｣o**    | Objeto A sabe sobre objeto B. Classe A depende de B;         |
| **Agregaﾃｧﾃ｣o**     | Objeto A sabe sobre objeto B, e consiste de B. Classe A depende de B; |
| **Composiﾃｧﾃ｣o**    | Objeto A sabe sobre objeto B, consiste de B, e gerencia o ciclo de vida de B. Classe A depende de B; |
| **Implementaﾃｧﾃ｣o** | Classe A define Mﾃｩtodos declarados na interface B. objetos de A podem ser tratados como B. Classe A depende de B; |
| **Heranﾃｧa**       | Classe A herda a interface e implementaﾃｧﾃ｣o da Classe B mas pode estende-la. Objetos de A podem ser tratados como B. Classe A depende de B. |

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="120px"/> | <div align="left">**DICA:** *Caso vocﾃｪ tenha dﾃｺvidas sobre o entendimento do Diagrama de Classes , <a href="uml.md">clique aqui</a> e veja um breve Resumo sobre Diagrama Classes e suas relaﾃｧﾃｵes.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Apﾃｳs compreender o Diagrama de Classes acima e aprender um pouco sobre UML, vamos implementar as nossas 3  Classes.

<h2>促 Passo 01 - Criar o Pacote Security</h2>

Primeiro vamos criar a camada de seguranﾃｧa, ou seja, o Pacote Security, onde as  Classes serﾃ｣o implementadas:

1. No lado esquerdo superior, na Guia **Package explorer**, clique com o botﾃ｣o direito do mouse sobre a Package **com.generation.blogpessoal**, na Source Folder **src/main/java** e clique na opﾃｧﾃ｣o  **New ｡ｪ Package**.

2. Na janela **New Java Package**, no item **Name**, acrescente no final do nome da Package **.security**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/pw8NoI1.png" title="source: imgur.com" /></div>

3. Clique no botﾃ｣o **Finish** para concluir.

<h2>促 Passo 02 - Criar a Classe UserDetailsImpl na Camada Security</h2>

A Classe **UserDetailsImpl** implementa a Interface **UserDetails**, que tem como principal funcionalidade fornecer as informaﾃｧﾃｵes bﾃ｡sicas do usuﾃ｡rio para o Spring Security (Usuﾃ｡rio, Senha, Direitos de acesso e as Restriﾃｧﾃｵes da conta). 

Apﾃｳs a autenticaﾃｧﾃ｣o (login) do usuﾃ｡rio no sistema, a Classe de Serviﾃｧo **UserDetailsServiceImpl** instanciarﾃ｡ um novo Objeto da Classe **UserDetailsImpl** com os respectivos Atributos preenchidos com os dados do usuﾃ｡rio autenticado (usuario e senha). Este Objeto tambﾃｩm conterﾃ｡ todos os Mﾃｩtodos herdados da Interface UserDetails, que consultam os Direitos de acesso (roles) e implementam as restriﾃｧﾃｵes da conta do usuﾃ｡rio.

1. Clique com o botﾃ｣o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.security**), na Source Folder Principal (**src/main/java**), e clique na opﾃｧﾃ｣o **New ｡ｪ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UserDetailsImpl**), e na sequﾃｪncia clique no botﾃ｣o **Finish** para concluir.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="250px"/> | <div align="left"> **ATENﾃﾃグ:** *Por se tratar de uma Implementaﾃｧﾃ｣o de uma Interface (UserDetails), todos os Mﾃｩtodos da Interface devem ser implementados e o nome da Classe deve obrigatoriamente conter o sufixo Impl (Implements), indicando que a Classe estﾃ｡ Implementando a Interface.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Vejamos abaixo a implementaﾃｧﾃ｣o da Classe UserDeatilsImpl:

```java
package com.generation.blogpessoal.security;

import java.util.Collection;
import java.util.List;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import com.generation.blogpessoal.model.Usuario;

public class UserDetailsImpl implements UserDetails{

private static final long serialVersionUID =1L;
	
	private String userName;
	private String password;
	
	private List<GrantedAuthority> authorities;
	
	public UserDetailsImpl (Usuario user){
		this.userName = user.getUsuario();
		this.password = user.getSenha();
	}
	
	public UserDetailsImpl (){ }
	
	@Override
	public Collection<? extends GrantedAuthority> getAuthorities() {
	
		return authorities;
	}

	@Override
	public String getPassword() {
	
		return password;
	}

	@Override
	public String getUsername() {
		
		return userName;
	}

	@Override
	public boolean isAccountNonExpired() {
		
		return true;
	}

	@Override
	public boolean isAccountNonLocked() {
		
		return true;
	}

	@Override
	public boolean isCredentialsNonExpired() {
		
		return true;
	}

    @Override
	public boolean isEnabled() {
		
		return true;
	}

}
```

<h3>Mﾃｩtodos da Interface com as restriﾃｧﾃｵes da conta:</h3>

| Mﾃｩtodo                        | Descriﾃｧﾃ｣o                                                    |
| ----------------------------- | ------------------------------------------------------------ |
| **isAccountNonExpired()**     | Indica se a conta do usuﾃ｡rio expirou. Uma conta expirada nﾃ｣o pode ser autenticada (return false). |
| **isAccountNonLocked()**      | Indica se o usuﾃ｡rio estﾃ｡ bloqueado ou desbloqueado. Um usuﾃ｡rio bloqueado nﾃ｣o pode ser autenticado (return false). |
| **isCredentialsNonExpired()** | Indica se as credenciais do usuﾃ｡rio (senha) expiraram. Senha expirada impede a autenticaﾃｧﾃ｣o (return false). |
| **isEnabled()**               | Indica se o usuﾃ｡rio estﾃ｡ habilitado ou desabilitado. Um usuﾃ｡rio desabilitado nﾃ｣o pode ser autenticado (return false). |

Para concluir, nﾃ｣o esqueﾃｧa de Salvar o cﾃｳdigo (**File ｡ｪ Save All**).

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="350px"/> |<div align="left"> ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, ﾃｩ necessﾃ｡rio ter um construtor adaptado para receber Atributos que serﾃ｣o utilizados para logar no sistema. Os Atributos em questﾃ｣o sﾃ｣o usuﾃ｡rio e senha, mas poderia ser tambﾃｩm e-mail e senha. Tudo irﾃ｡ depender de como a model de Usuario esta elaborada.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="350px"/> | <div align="left"> **ATENﾃﾃグ:** *Observe que o Mﾃｩtodo getAuthorities(), que retorna a lista com os direitos de acesso do usuﾃ｡rio, sempre retornarﾃ｡ uma List vazia, porquﾃｪ este Atributo nﾃ｣o pode ser Nulo. Com o objetivo de simplificar a nossa implementaﾃｧﾃ｣o, todo o Usuﾃ｡rio autenticado terﾃ｡ todos os direitos de acesso sobre a aplicaﾃｧﾃ｣o. * </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/UserDetails.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Interface UserDetails</i></b></a>

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/GrantedAuthority.html"><b>Documentaﾃｧﾃ｣o: <i>Mﾃｩtodo GrantedAuthority</i></b></a>

<h2>促 Passo 03 - Criar a Implementaﾃｧﾃ｣o da Classe UserDetailsServiceImpl</h2>

A Classe **UserDetailsServiceImpl** ﾃｩ uma implementaﾃｧﾃ｣o da Interface **UserDetailsService**, responsﾃ｡vel por validar a existﾃｪncia de um usuﾃ｡rio no sistema atravﾃｩs do Banco de dados e retornar um Objeto da Classe **UserDetailsImpl** (implementada no passo anterior), com os dados encontrados no Banco de dados. 

A Interface **UserDetailsService** permite autenticar um usuﾃ｡rio baseando-se na sua existﾃｪncia no Banco de dados (em nosso caso na tabela tb_usuarios). Vale lembrar que para isso ﾃｩ necessﾃ｡rio que ao persistir o usuﾃ｡rio no Banco de dados, **a senha obrigatoriamente deve estar criptografada** (Veremos na implementaﾃｧﾃ｣o da Classe **UsuarioService**), utilizando uma biblioteca de criptografia do Spring Security e **o usuario (e-mail) deve ser ﾃｺnico no sistema**, ou seja, nﾃ｣o podem existir 2 usuﾃ｡rios com o mesmo e-mail. 

1. Clique com o botﾃ｣o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.security**), na Source Folder Principal (**src/main/java**), e clique na opﾃｧﾃ｣o **New ｡ｪ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**UserDetailsServiceImpl**), e na sequﾃｪncia clique no botﾃ｣o **Finish** para concluir.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="250px"/> | <div align="left"> **ATENﾃﾃグ:** *Por se tratar de uma Implementaﾃｧﾃ｣o de uma Interface (UserDetailsService), todos os Mﾃｩtodos da Interface devem ser implementados e o nome da Classe deve obrigatoriamente conter o sufixo Impl (Implements), indicando que a Classe estﾃ｡ Implementando a Interface.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Vejamos abaixo a implementaﾃｧﾃ｣o da Classe:


```java
package com.generation.blogpessoal.security;

import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.generation.blogpessoal.model.Usuario;
import com.generation.blogpessoal.repository.UsuarioRepository;

@Service
public class UserDetailsServiceImpl implements UserDetailsService {
	
	@Autowired
	private UsuarioRepository usuarioRepository;

	@Override
	public UserDetails loadUserByUsername(String userName) throws UsernameNotFoundException {

		Optional<Usuario> usuario = usuarioRepository.findByUsuario(userName);

		if (usuario.isPresent())
			return new UserDetailsImpl(usuario.get());
		else
			throw new ResponseStatusException(HttpStatus.FORBIDDEN);
	}
}

```

O Mﾃｩtodo **loadUserByUsername(String username)** recebe o usuﾃ｡rio atravﾃｩs da tela de login do sistema e utiliza a Query Method **findByUsuario(String usuario)**, implementada na Interface **UsuarioRepository**, para checar se o usuﾃ｡rio digitado estﾃ｡ persistido no Banco de dados. 

Caso esteja persistido (**isPresent()**), ele executa o construtor da Classe **UserDetailsImpl**, passando o Objeto usuario como parﾃ｢metro. Observe que foi utilizado Mﾃｩtodo **get()** no Objeto usuario por se tratar de um Optional. 

Caso o usuﾃ｡rio nﾃ｣o exista, serﾃ｡ devolvido o **HTTP Status 403 - FORBIDDEN** (Acesso Proibido - vocﾃｪ estﾃ｡ tentando alcanﾃｧar um endereﾃｧo ou um site ao qual estﾃ｡ proibido de acessar).

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> ALERTA DE BSM: Mantenha a Atenﾃｧﾃ｣o aos Detalhes, ao criar esta Classe de Serviﾃｧo. Nﾃ｣o esqueﾃｧa de colocar a anotaﾃｧﾃ｣o @Service. </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/UserDetailsService.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Interface UserDetailsService</i></b></a>
<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status/403" target="_blank"><b>Documentaﾃｧﾃ｣o: HTTP Status Code 403 - Forbidden</b></a></div>

<h2>促 Passo 04 - Criar a Classe BasicSecurityConfig</h2>

A Classe **BasicSecurityConfig** ﾃｩ utilizada para sobrescrever a configuraﾃｧﾃ｣o padrﾃ｣o da **Spring Security**. A Classe BasicSecurityConfig possui 2 anotaﾃｧﾃｵes: 

- **@Configuration:** indica que a  Classe ﾃｩ do tipo configuraﾃｧﾃ｣o, ou seja, define uma Classe como fonte de  definiﾃｧﾃｵes de Beans, alﾃｩm de ser uma das anotaﾃｧﾃｵes essenciais ao utilizar uma configuraﾃｧﾃ｣o baseada em Java.
- **@EnableWebSecurity:** habilita a seguranﾃｧa de forma Global (toda a aplicaﾃｧﾃ｣o) e sobrescreve os Mﾃｩtodos que irﾃ｣o redefinir as regras de Seguranﾃｧa da sua aplicaﾃｧﾃ｣o.

> **Bean:** No Spring, os objetos que formam a espinha dorsal da sua aplicaﾃｧﾃ｣o e que sﾃ｣o gerenciados pelo Spring sﾃ｣o chamados de **Beans**. Um Bean ﾃｩ um objeto que ﾃｩ instanciado, montado e gerenciado pelo Spring. 
>
> Existem diversas formas de se criar Beans no Spring. Vocﾃｪ pode criar Classes anotadas com **@Configuration** ou **@Service** para serem gerenciadas pelo Spring, assim como pode usar a anotaﾃｧﾃ｣o **@Bean** em um Mﾃｩtodo, e transformar a instﾃ｢ncia retornada pelo Mﾃｩtodo em um Objeto gerenciado pelo Spring (seja de uma Classe prﾃｳpria ou de terceiros).
>
> Estas Classes, que na visﾃ｣o do Spring sﾃ｣o os Beans, para vocﾃｪ nada mais sﾃ｣o do que Classes que vocﾃｪ irﾃ｡ escrever as regras de funcionamento da sua aplicaﾃｧﾃ｣o, que poderﾃ｣o ser utilizadas em qualquer Classe, diferente da **Injeﾃｧﾃ｣o de Dependﾃｪncia** criada pela anotaﾃｧﾃ｣o **@Autowired**, que sﾃｳ permite o uso dentro da Classe em que foi criada.

1. Clique com o botﾃ｣o direito do mouse sobre o **Pacote Security** (**com.generation.blogpessoal.security**), na Source Folder Principal (**src/main/java**), e clique na opﾃｧﾃ｣o **New ｡ｪ Class**
2. Na janela **New Java Class**, no item **Name**, digite o nome da Classe (**BasicSecurityConfig**), e na sequﾃｪncia clique no botﾃ｣o **Finish** para concluir.

```java
package com.generation.blogpessoal.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class BasicSecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
            .sessionManagement()
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and().csrf().disable()
            .cors();

        http
            .authorizeHttpRequests((auth) -> auth
                .antMatchers("/usuarios/logar").permitAll()
                .antMatchers("/usuarios/cadastrar").permitAll()
                .antMatchers(HttpMethod.OPTIONS).permitAll()
                .anyRequest().authenticated())
            .httpBasic();

        return http.build();

    }

}
```

O Mﾃｩtodo ***passwordEncoder()*** , indica ao Spring Security que a aplicaﾃｧﾃ｣o estﾃ｡ baseada em um modelo de criptografia. Para esta aplicaﾃｧﾃ｣o estamos utilizando o modelo **BCryptPasswordEncoder()**, que se trata de um algoritmo de criptografia do tipo hash. Vale ressaltar que esta criptografia estﾃ｡ sendo esperada para analisar a senha que estamos guardando no Banco de dados.

> **Hash** ﾃｩ um algoritmo que transforma dados de comprimento variﾃ｡vel em dados de comprimento fixo codificados.


| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="120px"/> | <div align="left">Dica: No primeiro link abaixo vocﾃｪ pode conhecer mais sobre o algoritmo BCrypt e no segundo link vocﾃｪ pode testar a codificaﾃｧﾃ｣o e a decodificaﾃｧﾃ｣o de Strings geradas atravﾃｩs do algoritmo BCrypt.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://medium.com/reprogramabr/uma-breve-introdu%C3%A7%C3%A3o-sobre-bcrypt-f2fad91a7420" target="_blank"><b>Artigo: <i>Uma breve introduﾃｧﾃ｣o sobre BCrypt</i></b></a>

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://bcrypt-generator.com" target="_blank"><b>Site: <i>Codificador BCrypt</i></b></a>

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/4.2.4.RELEASE/apidocs/org/springframework/security/crypto/password/PasswordEncoder.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Interface PasswordEncoder</i></b></a>

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/4.2.4.RELEASE/apidocs/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Classe BCryptPasswordEncoder</i></b></a>

O Mﾃｩtodo ***authenticationManager(AuthenticationConfiguration authenticationConfiguration)***, implementa a confguraﾃｧﾃ｣o de autenticaﾃｧﾃ｣o. Este Mﾃｩtodo utiliza o Mﾃｩtodo ***authenticationConfiguration.getAuthenticationManager()*** para procurar uma implementaﾃｧﾃ｣o da Interface **UserDetailsService** e utilizﾃ｡-la para identificar se o usuﾃ｡rio ﾃｩ vﾃ｡lido ou nﾃ｣o. Em nosso projeto Blog Pessoal, serﾃ｡ utilizada a Classe **UserDetailsServiceImpl**, que valida o usuﾃ｡rio no Banco de dados.

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/authentication/AuthenticationManager.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>AuthenticationManager</i></b></a>

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/authentication/configuration/AuthenticationConfiguration.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>AuthenticationConfiguration</i></b></a>

O Mﾃｩtodo ***SecurityFilterChain filterChain(HttpSecurity http)***, estamos informando ao Spring que a configuraﾃｧﾃ｣o  padrﾃ｣o da Spring Security serﾃ｡ substituﾃｭda por uma nova configuraﾃｧﾃ｣o. Nesta configuraﾃｧﾃ｣o iremos customizar a autenticaﾃｧﾃ｣o da aplicaﾃｧﾃ｣o desabilitando o formulﾃ｡rio de login e habilitando a autenticaﾃｧﾃ｣o via http. 

Em nosso projeto Blog Pessoal, customizamos a nossa configuraﾃｧﾃ｣o em 2 partes:

**Parte 01 - Configuraﾃｧﾃｵes essenciais**

**Classe HttpSecurity**: Permite configurar a seguranﾃｧa baseada na Web para solicitaﾃｧﾃｵes http especﾃｭficas. Por padrﾃ｣o, serﾃ｡ aplicado a todas as requisiﾃｧﾃｵes que forem recebidas, mas pode ser restringido para apenas alguns endpoints.

**.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)**: Define que o nosso sistema nﾃ｣o guardarﾃ｡ sessﾃｵes para o cliente. Quando o cliente faz uma requisiﾃｧﾃ｣o HTTP, ele inclui todas as informaﾃｧﾃｵes necessﾃ｡rias para o servidor atender ﾃ requisiﾃｧﾃ｣o e a mesma ﾃｩ finalizada com a resposta do servidor. O servidor nunca dependerﾃ｡ de informaﾃｧﾃｵes de requisiﾃｧﾃｵes anteriores para processar uma nova requisiﾃｧﾃ｣o. 

**.csrf().disable()**: Desabilita a proteﾃｧﾃ｣o que vem ativa contra ataques do tipo **CSRF (Cross-Site-Request-Forgery)**, que seria uma interceptaﾃｧﾃ｣o dos dados de autenticaﾃｧﾃ｣o antes da requisiﾃｧﾃ｣o chegar ao servidor. Esta configuraﾃｧﾃ｣o foi desabilitada porquﾃｪ o Spring Security fica procurando por um *parﾃ｢metro oculto adicional* em **qualquer** requisiﾃｧﾃ｣o do tipo **POST / PUT / DELETE**, chamado **Token CSRF**. Como ele nﾃ｣o vai encontrar, todas as requisiﾃｧﾃｵes diferentes de **GET** seriam bloqueadas.

**.cors()**: Libera o acesso de outras origens, desta forma nossa aplicaﾃｧﾃ｣o poderﾃ｡ ser acessada de outros domﾃｭnios, ou seja, de outros endereﾃｧos, alﾃｩm do endereﾃｧo onde a aplicaﾃｧﾃ｣o estﾃ｡ hospedada.

**Exemplo 1 - CORS habilitado:**

<div align="center"><img src="https://i.imgur.com/GYBEXtM.png?1" title="source: imgur.com" /></div>

**Exemplo 2 - CORS Desabilitado:**
<div align="center"><img src="https://i.imgur.com/xnQRLBf.png?1" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="200px"/> | <div align="left"> **ATENﾃﾃグ:** *Nos exemplos acima, observe que o front-end e o back-end, embora estejam hospedados no mesmo servidor (Heroku), os Domﾃｭnios sﾃ｣o diferentes (frontend.herokuapp.com e backend.herokuapp.com), exigindo a habilitaﾃｧﾃ｣o do CORS* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

**Parte 02 - Configuraﾃｧﾃｵes especﾃｭficas:**

Nesta segunda parte estamos utilizando uma Expressﾃ｣o Lambda (***.authorizeHttpRequests((auth) -> auth)***) para definirmos as configuraﾃｧﾃｵes especﾃｭficas da aplicaﾃｧﾃ｣o. Essa Expressﾃ｣o Lambda ﾃｩ chamada de **Lambda DSL (Domain Specific Language -  Linguagem de Domﾃｭnio Especﾃｭfico)**, ou seja, ﾃｩ uma Expressﾃ｣o Lambda explicitamente adaptada para um uso especﾃｭfico (Spring Security), com o objetivo de reduzir a verbosidade do cﾃｳdigo, tornando-o mais limpo.

**.authorizeHttpRequests((auth) -> auth)**: Atravﾃｩs desta Expressﾃ｣o Lambda podemos definir quais endpoints poderﾃ｣o acessar o sistema sem precisar de autenticaﾃｧﾃ｣o. O Objeto **auth** recebe o endereﾃｧo (URI) da requisiﾃｧﾃ｣o e checa se o endpoint necessita ou nﾃ｣o de autenticaﾃｧﾃ｣o.

**.antMatchers("/usuarios/logar").permitAll() e .antMatchers("/usuarios/cadastrar").permitAll()**: Define os endereﾃｧos (URI) dos endpoints que estarﾃ｣o acessﾃｭveis sem autenticaﾃｧﾃ｣o. No projeto Blog Pessoal foi definido que apenas os endpoints **logar e cadastrar** serﾃ｣o livres de autenticaﾃｧﾃ｣o. 

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="250px"/> | <div align="left"> **ATENﾃﾃグ:** *Os endpoints cadastrar e logar foram liberados porquﾃｪ caso contrﾃ｡rio ninguﾃｩm conseguirﾃ｡ acessar a aplicaﾃｧﾃ｣o.* Os endereﾃｧos dos endpoints: /usuarios/logar e /usuarios/cadastrar devem estar obrigatoriamente definidos na implementaﾃｧﾃ｣o da Classe UsuarioController.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

**.antMatchers(HttpMethod.OPTIONS).permitAll()**: O parﾃ｢metro **HttpMethod.OPTIONS** permite que o cliente (front-end), possa descobrir quais sﾃ｣o as opﾃｧﾃｵes permitidas e/ou obrigatﾃｳrias no cabeﾃｧalho da requisiﾃｧﾃ｣o. Se o parﾃ｢metro **HttpMethod.OPTIONS** nﾃ｣o for liberado, a aplicaﾃｧﾃ｣o nﾃ｣o receberﾃ｡ o **Basic Token** atravﾃｩs do cabeﾃｧalho da requisiﾃｧﾃ｣o (Header), impedindo a aplicaﾃｧﾃ｣o de responder as requisiﾃｧﾃｵes protegidas.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="200px"/> | <div align="left"> **ATENﾃﾃグ:** *Liberar o parﾃ｢metro HttpMethod.OPTIONS de autenticaﾃｧﾃ｣o ﾃｩ essencial para o correto funcionamento do aplicaﾃｧﾃ｣o na nuvem, em especial na integraﾃｧﾃ｣o com o front-end. Sem essa configuraﾃｧﾃ｣o as requisiﾃｧﾃｵes do front-end nﾃ｣o serﾃ｣o autorizadas.*</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

**.anyRequest().authenticated():** Informa ao sistema que todos os endpoints que nﾃ｣o estiverem especificados na lista acima, a autenticaﾃｧﾃ｣o serﾃ｡ obrigatﾃｳria.

**.httpBasic()**: Informa ao sistema que o servidor irﾃ｡ receber requisiﾃｧﾃｵes que devem ter o esquema HTTP Basic de autenticaﾃｧﾃ｣o. Ao abrir a sua aplicaﾃｧﾃ｣o no navegador da Internet, ao invﾃｩs de abrir o formulﾃ｡rio que foi exibido ao habilitar a Spring Security, serﾃ｡ aberta a janela abaixo:

 <div align="center"><img src="https://i.imgur.com/mBRxYd8.png" title="source: imgur.com" width="50%"/></div>

**return http.build()**: Cria e instancia o Objeto http com as configuraﾃｧﾃｵes implementadas.

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/builders/HttpSecurity.html" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>HttpSecurity</i></b></a>

<div align="left"><img src="https://i.imgur.com/FEcFPvm.png" title="source: imgur.com" width="25px"/> <a href="https://spring.io/blog/2019/11/21/spring-security-lambda-dsl" target="_blank"><b>Documentaﾃｧﾃ｣o: <i>Expressﾃｵes Lambda DSL</i></b></a>
<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Authentication" target="_blank"><b>Documentaﾃｧﾃ｣o: HTTP Basic Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status/401" target="_blank"><b>Documentaﾃｧﾃ｣o: HTTP Status Code 401 - Unauthorized</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/CORS" target="_blank"><b>Documentaﾃｧﾃ｣o: CORS</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://reflectoring.io/complete-guide-to-csrf/" target="_blank"><b>Artigo: Complete Guide to CSRF/XSRF (Cross-Site Request Forgery)</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/conteudoGeneration/backend_blog_pessoal/tree/12-blog_pessoal_security_02" target="_blank"><b>Cﾃｳdigo fonte: Camada Security</b></a>

<br /><br />	

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
